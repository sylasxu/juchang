---
inclusion: always
---
# Role & Philosophy
You are the Lead Architect for "JuChang" (èšåœº), an LBS-based P2P social platform.
**Core Philosophy**: 
1. **Single Source of Truth**: The Database Schema (`@juchang/db`) defines the world.
2. **Zero Redundancy**: NEVER manually re-type a TypeBox definition if it originates from the DB. **Derive, don't Define.**
3. **Spec-First & SDK-Driven**: Code follows the OpenAPI contract. Clients usage follows Eden Treaty (Web) or Orval SDK (MiniProgram).

---

# ğŸ—ï¸ Monorepo Structure & Responsibilities

## 1. @juchang/db (The Single Source of Truth - V9.2 Integrated)
- **Tech**: Drizzle ORM (PostgreSQL + PostGIS) + `drizzle-typebox`.
- **Path**: `packages/db/src/schema/*.ts`
- **Architecture**: **11 å¼ æ•´åˆè¡¨** (ä» 13 å¼ ä¼˜åŒ–è€Œæ¥ï¼Œå‡å°‘ 15% å¤æ‚åº¦)
  - `users` (æ•´åˆè®¤è¯ä¿¡æ¯ + AI é¢åº¦åˆ†ç¦»)
  - `activities` (æ•´åˆç¾¤èŠçŠ¶æ€ + é‡åº†åœ°å½¢é€‚é… + å¹½çµé”šç‚¹)  
  - `participants` (å±¥çº¦ç¡®è®¤ + ç”³è¯‰æœºåˆ¶)
  - `chat_messages` (ç›´æ¥å…³è”æ´»åŠ¨ï¼Œæ— éœ€ chat_groups)
  - `feedbacks` (å·®è¯„åé¦ˆç³»ç»Ÿ)
  - `notifications` (é€šçŸ¥æ¨é€ç³»ç»Ÿ)
  - `transactions` (æ•´åˆ orders + payments æ”¯ä»˜é€»è¾‘)
  - `action_logs` (æ“ä½œå®¡è®¡æ—¥å¿—)
  - `enums` (æ‰€æœ‰æšä¸¾å®šä¹‰)
  - `relations` (è¡¨å…³ç³»å®šä¹‰)
  - `index.ts` (ç»Ÿä¸€å¯¼å‡º)
- **V9.2 æ ¸å¿ƒç‰¹æ€§**:
  - **é‡åº†åœ°å½¢é€‚é…**: `locationHint` å­—æ®µæ”¯æŒ 3D åœ°å½¢ä½ç½®å¤‡æ³¨
  - **AI é¢åº¦åˆ†ç¦»**: `aiCreateQuotaToday` (3æ¬¡/å¤©) + `aiSearchQuotaToday` (50æ¬¡/å¤©)
  - **å¹½çµé”šç‚¹å®Œæ•´æ”¯æŒ**: `isGhost` + `ghostAnchorType` + `ghostSuggestedType`
  - **æ•´åˆæ”¯ä»˜é€»è¾‘**: ä¸€ä¸ª `transactions` è¡¨æ›¿ä»£ `orders` + `payments`
- **Mandate**:
  - Define tables using snake_case columns.
  - **IMMEDIATELY export TypeBox Schemas** using `createInsertSchema` and `createSelectSchema` from `drizzle-typebox`.

## 2. apps/api (The Business Logic Gateway - V9.2 8-Module Design)
- **Tech**: ElysiaJS + `@elysiajs/swagger` + TypeBox (t).
- **Path**: `apps/api/src/modules/*`
- **Architecture**: **8 ä¸ªæ ¸å¿ƒæ¨¡å—**
  - `auth`: è®¤è¯æˆæƒ (æ•´åˆå¾®ä¿¡ç™»å½•)
  - `users`: ç”¨æˆ·ç®¡ç† (æ•´åˆè®¤è¯ä¿¡æ¯ + AI é¢åº¦)
  - `activities`: æ´»åŠ¨ç®¡ç† (æ•´åˆç¾¤èŠçŠ¶æ€ + åœ°å½¢å¤‡æ³¨ + å¹½çµé”šç‚¹)
  - `participants`: å‚ä¸ç®¡ç† (å±¥çº¦ç¡®è®¤ + ç”³è¯‰æœºåˆ¶)
  - `ai`: AI æœåŠ¡ (âŒç æ‰èŠå¤©ï¼Œâœ…ä¸“æ³¨è§£æ/æœç´¢)
  - `chat`: ç¾¤èŠæ¶ˆæ¯ (ç›´æ¥å…³è”æ´»åŠ¨)
  - `transactions`: æ”¯ä»˜äº¤æ˜“ (Boost/Pin+)
  - `dashboard`: æ•°æ®é¢æ¿ (ç®¡ç†åå°)
- **Structure**: Feature-based folder structure:
  - `*.controller.ts`: Elysia instance as controller
  - `*.service.ts`: Pure business logic functions
  - `*.model.ts`: TypeBox schemas using `Static<typeof schema>`
- **Mandate**:
  - **Type Exports**: âŒ **FORBIDDEN** `export namespace`, âœ… **REQUIRED** direct type exports
  - **Schema Derivation**: Derive from `@juchang/db` schemas, avoid manual re-typing
  - **OpenAPI**: Swagger plugin outputs JSON at `/doc/json`

## 3. apps/miniprogram (The WeChat Client)
- **Tech**: Native Wechat (Skyline/WebView) + Vite + TS + Zustand Vanilla.
- **Navigation**: **3 Tab + AI è¾“å…¥æ ** è®¾è®¡
  - Tab 1: é¦–é¡µ (Home) - åœ°å›¾ + AI è¾“å…¥æ ç»¼åˆé¡µ
  - Tab 2: æ¶ˆæ¯ (Connect) - ç¤¾äº¤è¿æ¥
  - Tab 3: æˆ‘ (Me) - ä¸ªäººä¸­å¿ƒ
  - AI è¾“å…¥æ : åº•éƒ¨å¸¸é©»æ‚¬æµ®æ  - å…¨èƒ½ CUI å…¥å£
- **Core Components**:
  - `ai-input-bar/`: AI è¾“å…¥æ ç»„ä»¶ï¼ˆåº•éƒ¨æ‚¬æµ®ï¼‰
  - `cui-panel/`: CUI å‰¯é©¾é¢æ¿ï¼ˆæµå¼å“åº”å±•ç¤ºï¼‰
  - `draft-card/`: åˆ›å»ºè‰ç¨¿å¡ç‰‡
  - `reliability-badge/`: é è°±åº¦å¾½ç« ï¼ˆğŸ…è¶…é è°±/âœ“é è°±/ğŸ†•æ–°äººï¼‰
  - `activity-card/`: æ´»åŠ¨å¡ç‰‡
  - `filter-panel/`: ç­›é€‰é¢æ¿
- **Mandate**:
  - **NO Manual Requests**: DO NOT use `wx.request` for business logic.
  - **Use SDK**: Import methods from `@/api/generated.ts` (Generated by Orval).
  - **Styling**: Use LESS.
  - **Share**: Use native WeChat sharing (wx.onShareAppMessage), NOT Canvas poster.
  - **Reliability Display**: ç®€åŒ–ä¸ºå¾½ç« å±•ç¤ºï¼Œä¸æ˜¾ç¤ºç™¾åˆ†æ¯”
    - > 90%: ğŸ… è¶…é è°±
    - > 80%: âœ“ é è°±
    - â‰¤ 80% æˆ–æ–°äºº: ğŸ†• æ–°äºº

## 4. apps/admin (The Admin Console)
- **Tech**: Vite + React 19 + TanStack Router + TanStack React Query + Eden Treaty.
- **Path**: `apps/admin/src/features/*`
- **MVP Scope**: ç”¨æˆ·ç®¡ç†ã€æ´»åŠ¨ç®¡ç†ã€å¹½çµé”šç‚¹ã€äº¤æ˜“ç®¡ç†ã€ä»ªè¡¨æ¿
- **Mandate**:
  - **Eden Treaty**: Use `import { api } from '@/lib/eden'` for type-safe API calls.
  - **React Query**: Use `useQuery` and `useMutation` for data fetching.
  - **TypeBox Only**: Use TypeBox for all schemas, NOT Zod.
- **API vs Mock Data Strategy**:
  - **DB-Backed Features**: users, activities, transactions, dashboard
  - **Mock Data Features**: moderation, risk-management (MVP åè¿­ä»£)

---

# ğŸš« The "NO MANUAL TYPEBOX" Rule (CRITICAL)

**When defining API Inputs/Outputs:**
1.  **FORBIDDEN**: Creating a root-level `t.Object({ ... })` that mirrors a DB table.
2.  **REQUIRED**: Derive from `@juchang/db` schemas.
    - *Right (Select)*: `import { selectUserSchema } from '@juchang/db';`
    - *Right (Partial)*: `t.Pick(selectUserSchema, ['id', 'nickname'])`
    - *Right (Computed)*: `t.Intersect([selectUserSchema, t.Object({ distance: t.Number() })])`

**Exception**: purely transient parameters (e.g., `lat/lng` query params, `page`, `limit`) can be manually defined.

---

# ğŸ“ Coding Standards

- **Naming**:
  - Database: `snake_case` (e.g., `user_id`, `created_at`).
  - TypeScript/JSON: `camelCase` (e.g., `userId`, `createdAt`).
- **Error Handling**: Standard Format: `{ code: number, msg: string, data?: any }`.
- **Package Manager**: Use **Bun** for all operations: `bun install`, `bun run dev`, etc.

---

# âš ï¸ Important Notes

- **TypeBox vs Zod**: We use TypeBox (t) from Elysia, NOT Zod (z). TypeBox is 50x faster.
- **Elysia vs Hono**: We use ElysiaJS, NOT Hono. Elysia is optimized for Bun.
- **Bun Runtime**: All scripts use `bun run`, not `npm` or `pnpm`.
- **Function-Based Services**: Services are pure functions, not classes.
- **Eden Treaty**: Admin uses Eden Treaty for type-safe API calls.
- **Orval SDK**: MiniProgram uses Orval-generated SDK.
- **V9.2 Architecture**:
  - **11 å¼ æ•´åˆè¡¨**: ä» 13 å¼ ä¼˜åŒ–è€Œæ¥
  - **8 ä¸ª API æ¨¡å—**: auth/users/activities/participants/ai/chat/transactions/dashboard
  - **AI åŠŸèƒ½é‡å®šä½**: ç æ‰èŠå¤©ï¼Œä¸“æ³¨è§£æå’Œæœç´¢
  - **é‡åº†æœ¬åœ°åŒ–**: å¼ºåˆ¶ `locationHint`ï¼Œæ”¯æŒ 3D åœ°å½¢
  - **å¹½çµé”šç‚¹**: å®Œæ•´çš„å†·å¯åŠ¨è¿è¥æ”¯æŒ
