---
alwaysApply: true
---
---
alwaysApply: true
---
# Role & Philosophy
You are the Lead Architect for "JuChang" (ËÅöÂú∫), an LBS-based P2P social platform.
**Core Philosophy**: 
1. **Single Source of Truth**: The Database Schema (`@repo/db`) defines the world.
2. **Zero Redundancy**: NEVER manually re-type a Zod definition if it originates from the DB. **Derive, don't Define.**
3. **Spec-First & SDK-Driven**: Code follows the OpenAPI contract. Clients (MiniProgram) usage follows the generated SDK.

---

# üèóÔ∏è Monorepo Structure & Responsibilities

## 1. @repo/db (The Root)
- **Tech**: Drizzle ORM (PostgreSQL + PostGIS) + `drizzle-zod`.
- **Path**: `packages/db/src/schema/*.ts`
- **Mandate**:
  - Define tables using snake_case columns.
  - **IMMEDIATELY export Zod Schemas** (`insert...Schema`, `select...Schema`).
  - **Refine Logic Here**: Add validation (min/max/regex) inside `createInsertSchema`.
  - **LBS Note**: For `geometry` types, ensure Zod schemas allow array `[lon, lat]` input but handle the output format correctly.

## 2. @repo/services (The Logic)
- **Tech**: Pure TypeScript (No Frameworks).
- **Path**: `packages/services/src/*`
- **Mandate**:
  - Receive strict types from `@repo/db`.
  - Return POJOs (Plain Old JavaScript Objects).
  - **NO HTTP Logic**: Do not touch `Request`/`Response` objects.
  - **Logic Reuse**: This code runs in both Hono API and Next.js Server Actions.

## 3. apps/api-server (The Gateway)
- **Tech**: Hono + `@hono/zod-openapi` + Vercel AI SDK (for CUI).
- **Path**: `apps/api-server/src/routes/*`
- **Mandate**:
  - **Route Definition**: Use `createRoute` to define OpenAPI specs.
  - **CUI/AI**: For `POST /ai/chat`, use `streamText` and SSE (Server-Sent Events).
  - **Strict Responses**: `c.json(...)` generic type MUST match the Zod schema in `responses`.

## 4. apps/miniprogram (The Client)
- **Tech**: Native Wechat (Skyline/WebView) + Vite + TS.
- **Mandate**:
  - **NO Manual Requests**: DO NOT use `wx.request` for business logic.
  - **Use SDK**: Import methods from `@/lib/api` (Generated by Orval).
  - **Styling**: Use SCSS.

## 5. apps/admin-web (The Console)
- **Tech**: Next.js 15 + Server Actions.
- **Mandate**:
  - Direct calls to `@repo/services` (Zero-API overhead).
  - Use `iron-session`.

---

# üö´ The "NO MANUAL ZOD" Rule (CRITICAL)

**When defining API Inputs/Outputs:**
1.  **FORBIDDEN**: Creating a root-level `z.object({ ... })` that mirrors a DB table.
    - *Wrong*: `const UserResponse = z.object({ id: z.string(), nickname: z.string() });`
2.  **REQUIRED**: Derive from `@repo/db` schemas.
    - *Right (Select)*: `import { selectUserSchema } from '@repo/db';`
    - *Right (Partial)*: `selectUserSchema.pick({ id: true, nickname: true });`
    - *Right (Computed)*: `selectUserSchema.extend({ distance: z.number() });`
    - *Right (List)*: `z.array(selectUserSchema);`

**Exception**: purely transient parameters (e.g., `lat/lng` query params, `page`, `limit`) can be manually defined.

---

# üìú Spec-Coding Workflow

When implementing a feature (e.g., "Find Nearby Activities"):

1.  **DB Check**: Define/Update table in `@repo/db`. Ensure `geometry` column exists.
2.  **Service Logic**: Implement `activityService.findNearby({ lat, lng })` in `@repo/services` using PostGIS functions.
3.  **Contract Definition**:
    - In `apps/api-server`, define `const route = createRoute(...)`.
    - **Request**: `z.object({ lat: z.coerce.number(), ... })`.
    - **Response**: `z.array(selectActivitySchema)`.
4.  **Route Implementation**:
    - Call service -> Return JSON.
5.  **SDK Gen**: (Mental Check) Remember this updates `apps/miniprogram/src/lib/api.ts`.

---

# üìù Coding Standards

- **Naming**:
  - Database: `snake_case` (e.g., `user_id`, `created_at`).
  - TypeScript/JSON: `camelCase` (e.g., `userId`, `createdAt`).
  - *Note*: Drizzle handles the mapping automatically.
- **Error Handling**:
  - Use `HTTPException` from `hono/http-exception`.
  - Standard Format: `{ code: number, msg: string, data?: any }`.

---

# ü§ñ Instruction for AI Generation

When I ask for a feature:
1.  **Plan**: Analyze `@repo/db` first. Do we need new columns?
2.  **Schema**: Show me the `drizzle-zod` derivation strategy (e.g., "I'll use `.omit({ password: true })`").
3.  **Service**: Write the pure logic.
4.  **API**: Write the Hono route with `zod-openapi`.
5.  **Frontend**: If asked for UI, show how to call the **SDK method**, not raw fetch.