è¿™ä»½ **ã€Šèšåœº (Juchang) - ç°ä»£åŒ–å…¨æ ˆæ¶æ„æ–¹æ¡ˆã€‹** æ˜¯åŸºäºæˆ‘ä»¬å¤šè½®æ·±åº¦è®¨è®ºçš„æœ€ç»ˆå®šç¨¿ã€‚

é‡‡ç”¨äº† **â€œåŸç”Ÿå°ç¨‹åº + Next.js Web + Hono API + Drizzle ORMâ€** çš„ç°ä»£åŒ–å…¨æ ˆæ¶æ„ï¼ŒåŒæ—¶åˆ©ç”¨ **Monorepo** å’Œ **Internal Packages** å®ç°äº†åç«¯ä¸å‰ç«¯ã€Web ä¸å°ç¨‹åºä¹‹é—´çš„é€»è¾‘å¤ç”¨ã€‚

---

# èšåœº (Juchang) - æ€»ä½“æŠ€æœ¯æ¶æ„æ–¹æ¡ˆ (v4.0 Final)

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

1.  **åŸç”Ÿæè‡´æ€§èƒ½**ï¼šå°ç¨‹åºç«¯å®Œå…¨æ”¾å¼ƒ React/Vue è¿è¡Œæ—¶ï¼Œç¼–å†™åŸç”Ÿ `WXML/WXSS/TS`ï¼Œç¡®ä¿å¯åŠ¨é€Ÿåº¦å’Œè¿è¡Œæ€§èƒ½è¾¾åˆ°â€œå¤©èŠ±æ¿â€çº§åˆ«ã€‚
2.  **ç°ä»£åŒ–å…¨æ ˆä½“éªŒ**ï¼šWebç«¯é‡‡ç”¨ **Next.js 15** (App Router) æä¾›å“è¶Šçš„SSR/SSGä½“éªŒï¼ŒAPIå±‚ä½¿ç”¨ **Hono** æä¾›é«˜æ€§èƒ½çš„Edgeè¿è¡Œæ—¶æ”¯æŒã€‚
3.  **é€»è¾‘é«˜åº¦å¤ç”¨**ï¼šé‡‡ç”¨ **Monorepo (Internal Packages)** ç­–ç•¥ï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆç”¨æˆ·ç®¡ç†ã€LBSç®—æ³•ã€æ”¯ä»˜ã€AIï¼‰å°è£…ä¸ºçº¯ TS æºç åŒ…ï¼ŒAPIç«¯ã€Webç«¯å’Œå°ç¨‹åºç«¯**ç›´æ¥å¼•ç”¨æºç **ï¼Œæ— ä¸­é—´ç¼–è¯‘äº§ç‰©ã€‚
4.  **ç±»å‹å®‰å…¨ä¼˜å…ˆ**ï¼šä»æ•°æ®åº“åˆ°APIåˆ°å‰ç«¯ï¼Œå…¨é“¾è·¯TypeScriptï¼Œç»“åˆ **Drizzle ORM** å’Œ **Zod** å®ç°ç«¯åˆ°ç«¯çš„ç±»å‹å®‰å…¨ã€‚
5.  **æœªæ¥ä¸è¿‡æ—¶**ï¼šåŸºäº Web æ ‡å‡†ï¼ˆHono, PostGIS, Drizzleï¼‰ï¼Œä¸ä¾èµ–ç‰¹å®šå‚å•†çš„é»‘ç›’æ¡†æ¶ï¼Œæ¶æ„ç”Ÿå‘½å‘¨æœŸé•¿ã€‚

---

## 2. æŠ€æœ¯æ ˆå…¨æ™¯å›¾ (Tech Stack)

| æ¨¡å—           | é€‰å‹                     | æ ¸å¿ƒç†ç”±                                                                     |
| :------------- | :----------------------- | :--------------------------------------------------------------------------- |
| **ä»£ç ç®¡ç†**   | **Turborepo + pnpm**     | ä»»åŠ¡ç¼–æ’ä¸ä¾èµ–ç®¡ç†ï¼Œæ”¯æŒæºç å¼•ç”¨çš„ Workspace æ¨¡å¼ã€‚                          |
| **å°ç¨‹åºæ„å»º** | **weapp-vite (Native)**  | **æ ¸å¿ƒå˜é©ç‚¹**ã€‚ä½¿ç”¨ Vite ç¼–è¯‘åŸç”Ÿå°ç¨‹åºï¼Œæ”¯æŒ TSã€SCSSï¼Œé›¶è¿è¡Œæ—¶å¼€é”€ã€‚ |
| **Webåº”ç”¨**    | **Next.js 15 (App Router)** | ç°ä»£åŒ–çš„å…¨æ ˆReactæ¡†æ¶ï¼Œæä¾›å“è¶Šçš„SSR/SSGä½“éªŒï¼Œæ”¯æŒReact 19æ–°ç‰¹æ€§ã€‚ |
| **APIç½‘å…³**    | **Hono**                 | ç¬¦åˆ Web Standards çš„é«˜æ€§èƒ½åç«¯ï¼Œæ”¯æŒ Node/Edgeï¼Œç±»å‹æ¨æ–­æè‡´ã€‚              |
| **æ•°æ®åº“**     | **PostgreSQL + PostGIS** | å¤„ç† LBS ç¤¾äº¤ï¼ˆé™„è¿‘çš„äººã€åœ°ç†å›´æ ã€è·ç¦»è®¡ç®—ï¼‰çš„è¡Œä¸šæ ‡å‡†ã€‚                    |
| **ORM**        | **Drizzle ORM**          | TypeScript Nativeï¼Œæ— è¿è¡Œæ—¶å¼€é”€ï¼Œç”Ÿæˆé«˜æ•ˆ SQLï¼Œå®Œç¾æ”¯æŒZodæ¨¡å¼éªŒè¯ã€‚        |
| **æ¨¡å¼éªŒè¯**   | **Zod**                  | TypeScriptä¼˜å…ˆçš„æ¨¡å¼éªŒè¯åº“ï¼Œä¸Drizzleå®Œç¾é›†æˆï¼Œå®ç°ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ã€‚        |
| **åŸºç¡€è®¾æ–½**   | **Redis + Docker**       | ç¼“å­˜ä¸å®¹å™¨åŒ–éƒ¨ç½²ã€‚                                                           |
| **AI/é£æ§**    | **LLM API + è…¾è®¯äº‘ IMS** | é€šè¿‡ Hono æµå¼è¾“å‡º AI å“åº”ï¼›å¼ºåˆ¶æ¥å…¥ç¬¬ä¸‰æ–¹å†…å®¹å®‰å…¨æœåŠ¡ã€‚                     |

---

## 3. ç³»ç»Ÿé€»è¾‘æ¶æ„å›¾

```mermaid
graph TD
    subgraph "Client Side (å‰ç«¯åº”ç”¨)"
        MP[å¾®ä¿¡å°ç¨‹åº (Native + Vite)]
        Web[Webåº”ç”¨ (Next.js 15 App Router)]
        Admin[ç®¡ç†åå° (Next.js 15)]
    end

    subgraph "Server Side (æœåŠ¡ç«¯)"
        API[Hono API Gateway]
        Next[Next.js API Routes]
    end

    subgraph "Shared Logic Layer (çº¯ TS æºç åŒ…)"
        Services[Serviceså±‚ (ç”¨æˆ·/LBS/AI)]
        DB[Databaseå±‚ (Drizzle + Zod)]
        Utils[é€šç”¨å·¥å…· (Format/Validator)]
    end

    subgraph "Data Layer (åŸºç¡€è®¾æ–½)"
        PostgreSQL[(PostgreSQL + PostGIS)]
        Redis[(Redis Cache)]
        LLM[å¤§æ¨¡å‹ API]
        RiskAPI[è…¾è®¯äº‘å†…å®¹å®‰å…¨]
    end

    %% ç¼–è¯‘æ—¶ä¾èµ– (Build Time)
    MP -.->|Vite ç¼–è¯‘å¼•å…¥| Services & Utils
    Web -.->|Next.js ç¼–è¯‘å¼•å…¥| Services & Utils
    Admin -.->|Next.js ç¼–è¯‘å¼•å…¥| Services & Utils

    %% è¿è¡Œæ—¶ä¾èµ– (Runtime)
    API -->|Import| Services
    Next -->|Import| Services
    Services -->|Drizzle ORM| DB
    DB -->|SQL| PostgreSQL
    
    MP -->|HTTPS / WSS| API
    Web -->|HTTPS| Next
    Admin -->|HTTPS| API

    %% æ•°æ®æµå‘
    Services -->|Cache| Redis
    API -->|SSE Stream| MP
    Services -->|Content Check| RiskAPI
    Services -->|AI Stream| LLM
```

---

## 4. ç›®å½•ç»“æ„è®¾è®¡ (Internal Packages æ¨¡å¼)

æ‰€æœ‰ `packages/*` å‡é…ç½®ä¸º **No-Build** æ¨¡å¼ï¼ˆ`main` æŒ‡å‘ `.ts`ï¼‰ï¼Œç”±ä¸Šå±‚åº”ç”¨ï¼ˆAppsï¼‰çš„ Vite/Next.js è´Ÿè´£ç¼–è¯‘ã€‚

```text
/root
  â”œâ”€â”€ apps/
  â”‚    â”œâ”€â”€ miniprogram/             # [WeChat åŸç”Ÿ] Vite+TS å·¥ç¨‹
  â”‚    â”‚    â”œâ”€â”€ src/pages/*         # ç›´æ¥ import @juchang/services
  â”‚    â”‚    â”œâ”€â”€ vite.config.ts
  â”‚    â”‚    â””â”€â”€ tsconfig.json
  â”‚    â”‚
  â”‚    â”œâ”€â”€ web/                     # [Next.js 15] ä¸» Web åº”ç”¨
  â”‚    â”‚    â”œâ”€â”€ app/                # App Router + API Routes
  â”‚    â”‚    â”œâ”€â”€ next.config.ts
  â”‚    â”‚    â””â”€â”€ middleware.ts
  â”‚    â”‚
  â”‚    â”œâ”€â”€ api/                     # [Nest] BFF å±‚
  â”‚    â”‚    â”œâ”€â”€ src/
  â”‚    â”‚    â”‚    â”œâ”€â”€ common/        # åˆ‡é¢å±‚ (decorators/filters/guards/â€¦)
  â”‚    â”‚    â”‚    â”œâ”€â”€ config/        # é…ç½®åŠ è½½ + æ ¡éªŒ
  â”‚    â”‚    â”‚    â”œâ”€â”€ modules/
  â”‚    â”‚    â”‚    â”‚    â”œâ”€â”€ global/   # factories + global.module.ts
  â”‚    â”‚    â”‚    â”‚    â”œâ”€â”€ auth/ users/ activities/
  â”‚    â”‚    â”‚    â”‚    â”œâ”€â”€ products/ orders/ payments/ assets/
  â”‚    â”‚    â”‚    â”‚    â””â”€â”€ health/
  â”‚    â”‚    â”‚    â”œâ”€â”€ app.module.ts
  â”‚    â”‚    â”‚    â””â”€â”€ main.ts
  â”‚    â”‚    â”œâ”€â”€ test/               # e2e æµ‹è¯•
  â”‚    â”‚    â””â”€â”€ package.json
  â”‚    â”‚
  â”‚    â””â”€â”€ edge/                    # [Hono] Edge/API Gatewayï¼ˆå¤‡ç”¨ï¼‰
  â”‚         â””â”€â”€ src/index.ts
  â”‚
  â”œâ”€â”€ packages/
  â”‚    â”œâ”€â”€ db/                      # Drizzle ORM + PostGIS Schema
  â”‚    â”‚    â”œâ”€â”€ drizzle.config.ts
  â”‚    â”‚    â”œâ”€â”€ src/
  â”‚    â”‚    â”‚    â”œâ”€â”€ db.ts / migrate.ts / index.ts
  â”‚    â”‚    â”‚    â””â”€â”€ schema/
  â”‚    â”‚    â”‚         â”œâ”€â”€ enums.ts
  â”‚    â”‚    â”‚         â”œâ”€â”€ users.ts / user_auths.ts
  â”‚    â”‚    â”‚         â”œâ”€â”€ activities.ts / participants.ts
  â”‚    â”‚    â”‚         â”œâ”€â”€ products.ts / orders.ts / payments.ts
  â”‚    â”‚    â”‚         â”œâ”€â”€ user_assets.ts / asset_records.ts
  â”‚    â”‚    â”‚         â””â”€â”€ ai_messages.ts / ai_conversations.ts (é¢„ç•™)
  â”‚    â”‚    â””â”€â”€ package.json
  â”‚    â”‚
  â”‚    â”œâ”€â”€ services/                # é¢†åŸŸæœåŠ¡å±‚ï¼ˆçº¯ TSï¼‰
  â”‚    â”‚    â”œâ”€â”€ src/
  â”‚    â”‚    â”‚    â”œâ”€â”€ auth/
  â”‚    â”‚    â”‚    â”œâ”€â”€ users/
  â”‚    â”‚    â”‚    â”œâ”€â”€ activities/
  â”‚    â”‚    â”‚    â”œâ”€â”€ products/
  â”‚    â”‚    â”‚    â”œâ”€â”€ orders/
  â”‚    â”‚    â”‚    â”œâ”€â”€ payments/
  â”‚    â”‚    â”‚    â”œâ”€â”€ assets/
  â”‚    â”‚    â”‚    â””â”€â”€ ai.ts / lbs.ts / utils.ts
  â”‚    â”‚    â””â”€â”€ package.json
  â”‚    â”‚
  â”‚    â”œâ”€â”€ utils/                   # é€šç”¨å·¥å…·åŒ… (æ ¼å¼åŒ– / åŠ è§£å¯†)
  â”‚    â””â”€â”€ ts-config/               # ç»Ÿä¸€ TypeScript é…ç½®
  â”‚
  â”œâ”€â”€ docker/                      # åŸºç¡€è®¾æ–½ï¼ˆPostgres + Redisï¼‰
  â”‚    â”œâ”€â”€ docker-compose.yml
  â”‚    â”œâ”€â”€ postgres/               # è‡ªå®šä¹‰é•œåƒ + init SQL
  â”‚    â””â”€â”€ .env.example
  â”‚
  â”œâ”€â”€ turbo.json                   # Turborepo pipeline
  â”œâ”€â”€ pnpm-workspace.yaml          # Workspace è¾¹ç•Œ
  â””â”€â”€ .env.example                 # æ ¹ç¯å¢ƒå˜é‡æ¨¡æ¿
```

---

## 5. API åº”ç”¨å±‚æ¶æ„ï¼ˆNest ç‰ˆï¼‰

> Hono ä¾æ—§ä½œä¸º Edge/Serverless ç½‘å…³çš„å¤‡ç”¨å®ç°ï¼›å½“å‰ä¸»åŠ› API é€‰æ‹© Nestï¼ˆapps/apiï¼‰ï¼Œè´Ÿè´£ BFF ä»¥åŠå†…éƒ¨ç®¡ç†æ¥å£ã€‚æ–°ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
apps/api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ common/                      # [AOP åˆ‡é¢å±‚] é€šç”¨åŸºç¡€è®¾æ–½ (The Shield)
â”‚   â”‚   â”œâ”€â”€ constants/               # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ metadata.keys.ts     # å¦‚ 'IS_PUBLIC_KEY'
â”‚   â”‚   â”‚   â””â”€â”€ error-codes.ts       # è‡ªå®šä¹‰ä¸šåŠ¡é”™è¯¯ç 
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ decorators/              # è‡ªå®šä¹‰è£…é¥°å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ current-user.ts      # @CurrentUser() æå– JWT ç”¨æˆ·
â”‚   â”‚   â”‚   â”œâ”€â”€ public.ts            # @Public() è·³è¿‡ Auth å®ˆå«
â”‚   â”‚   â”‚   â”œâ”€â”€ client-ip.ts         # @IpAddress() è·å–çœŸå® IP
â”‚   â”‚   â”‚   â””â”€â”€ roles.ts             # @Roles('admin')
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ filters/                 # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”‚   â”‚   â””â”€â”€ all-exceptions.filter.ts # å…¨å±€å…œåº• -> { code: 500, msg: ... }
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ guards/                  # å®ˆå«
â”‚   â”‚   â”‚   â”œâ”€â”€ jwt-auth.guard.ts    # å…¨å±€ JWT æ ¡éªŒ
â”‚   â”‚   â”‚   â””â”€â”€ roles.guard.ts       # æƒé™æ ¡éªŒ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ interceptors/            # æ‹¦æˆªå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ transform.interceptor.ts # å“åº”åŒ…è£… -> { code: 0, data: ... }
â”‚   â”‚   â”‚   â”œâ”€â”€ logging.interceptor.ts   # å®¡è®¡æ—¥å¿—/æ€§èƒ½ç›‘æ§
â”‚   â”‚   â”‚   â””â”€â”€ timeout.interceptor.ts   # è¶…æ—¶æ§åˆ¶
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ middleware/              # Express ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ xml-body.middleware.ts   # å¾®ä¿¡æ”¯ä»˜å›è°ƒ XML è§£æ
â”‚   â”‚   â”‚   â”œâ”€â”€ request-id.middleware.ts # å…¨é“¾è·¯ Trace ID
â”‚   â”‚   â”‚   â””â”€â”€ access-log.middleware.ts # HTTP è®¿é—®æ—¥å¿—
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ pipes/                   # ç®¡é“
â”‚   â”‚   â”‚   â””â”€â”€ zod-validation.pipe.ts   # DTO éªŒè¯
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ utils/                   # çº¯å·¥å…·å‡½æ•°
â”‚   â”‚       â”œâ”€â”€ crypto.util.ts
â”‚   â”‚       â””â”€â”€ date.util.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                      # [é…ç½®å±‚]
â”‚   â”‚   â”œâ”€â”€ configuration.ts         # åŠ è½½ .env
â”‚   â”‚   â””â”€â”€ env.validation.ts        # æ ¡éªŒ .env å®Œæ•´æ€§
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/                     # [è¡¨ç°å±‚] æ‰å¹³åŒ–æ¨¡å—åˆ—è¡¨
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ global/                  # ğŸŒ [å…¨å±€åŸºåº§] (è¿æ¥ Monorepo çš„å¿ƒè„)
â”‚   â”‚   â”‚   â”œâ”€â”€ factories/           # ğŸ­ å®ä¾‹åŒ–å·¥å‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ users.factory.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ wechat.factory.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ activities.factory.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ products.factory.ts  # å•†å“æœåŠ¡å·¥å‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ orders.factory.ts    # è®¢å•æœåŠ¡å·¥å‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ payments.factory.ts  # æ”¯ä»˜æœåŠ¡å·¥å‚
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ assets.factory.ts    # èµ„äº§æœåŠ¡å·¥å‚
â”‚   â”‚   â”‚   â””â”€â”€ global.module.ts     # @Global() æ¨¡å—ï¼Œå¯¼å‡ºæ‰€æœ‰ Service
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ auth/                    # ğŸ” è®¤è¯æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ wechat-login.dto.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth-response.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.controller.ts   # POST /auth/login
â”‚   â”‚   â”‚   â””â”€â”€ auth.module.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ users/                   # ğŸ‘¤ ç”¨æˆ·æ¨¡å— (ç”»åƒ/èµ„æ–™)
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ update-profile.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ users.controller.ts  # GET /users/me, PATCH /users/me
â”‚   â”‚   â”‚   â””â”€â”€ users.module.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ activities/              # ğŸ¸ æ´»åŠ¨æ¨¡å— (LBS/ç»„å±€)
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create-activity.dto.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ find-nearby.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ activities.controller.ts # POST /activities, GET /activities/nearby
â”‚   â”‚   â”‚   â””â”€â”€ activities.module.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ products/                # ğŸ›ï¸ å•†å“æ¨¡å— (å®šä¹‰å–ä»€ä¹ˆ)
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ products.controller.ts   # GET /products (é‡‘å¸åŒ…/ä¼šå‘˜å¡)
â”‚   â”‚   â”‚   â””â”€â”€ products.module.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ orders/                  # ğŸ§¾ è®¢å•æ¨¡å— (äº¤æ˜“æµè½¬)
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ create-order.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ orders.controller.ts     # POST /orders (ä¸‹å•)
â”‚   â”‚   â”‚   â””â”€â”€ orders.module.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ payments/                # ğŸ’³ æ”¯ä»˜æ¨¡å— (ç½‘å…³äº¤äº’)
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ payments.controller.ts   # POST /payments/callback/wechat
â”‚   â”‚   â”‚   â””â”€â”€ payments.module.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ assets/                  # ğŸ’° èµ„äº§æ¨¡å— (åŒè´¦æœ¬/é’±åŒ…)
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ assets.controller.ts     # GET /assets/balance, GET /assets/records
â”‚   â”‚   â”‚   â””â”€â”€ assets.module.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ health/                  # ğŸ¥ è¿ç»´æ¨¡å—
â”‚   â”‚       â”œâ”€â”€ health.controller.ts     # GET /health
â”‚   â”‚       â””â”€â”€ health.module.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ app.module.ts                # æ ¹æ¨¡å— (ç»„è£…ä»¥ä¸Šæ‰€æœ‰)
â”‚   â””â”€â”€ main.ts                      # å…¥å£æ–‡ä»¶ (Express, 0.0.0.0)
â”‚
â”œâ”€â”€ test/                            # E2E æµ‹è¯•
â”‚   â”œâ”€â”€ app.e2e-spec.ts
â”‚   â””â”€â”€ jest-e2e.json
â”œâ”€â”€ .env.example
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ .prettierrc
â”œâ”€â”€ nest-cli.json
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

æ•´ä½“å¯åŠ¨æµç¨‹ï¼š

1. `main.ts` æŒ‚è½½æ‰€æœ‰å…¨å±€ä¸­é—´ä»¶ï¼ˆXML è§£æã€RequestIdã€è®¿é—®æ—¥å¿—ï¼‰ä¸åˆ‡é¢ã€‚
2. `app.module.ts` ç»„è£… Configã€Commonã€Global åŠæ‰€æœ‰ Feature modulesã€‚
3. `modules/global` é€šè¿‡ factories ç›´è¿ `packages/services`ï¼Œä»¥ @Global æ³¨å…¥æ–¹å¼å‘å…¨å±€æä¾›é¢†åŸŸæœåŠ¡ã€‚
4. äº¤æ˜“åŸŸã€èµ„äº§åŸŸè¢«æ‹†åˆ†æˆ Product/Order/Payment/Asset å››ä¸ªæ¨¡å—ï¼ŒèŒè´£å•ä¸€ã€è¾¹ç•Œæ¸…æ™°ã€‚
5. Edge ä¾§å¦‚éœ€ Honoï¼Œå¯åœ¨ `apps/edge` ç»§ç»­å…±äº«åŒä¸€ services å±‚ã€‚

### ğŸŒŸ æ¶æ„æ ¸å¿ƒé€»è¾‘

**1. æ‰å¹³åŒ–äº¤æ˜“åŸŸ**  
- `modules/products` ä»…æä¾› SKU å±•ç¤ºï¼Œå®Œå…¨ä¸è§¦ç¢°äº¤æ˜“æµç¨‹ã€‚  
- `modules/orders` è´Ÿè´£åˆ›å»ºè®¢å•ã€å†³å®šåç»­åŠ¨ä½œï¼ˆè·³è½¬æ”¯ä»˜ / èµ°èµ„äº§æ‰£å‡ï¼‰ã€‚  
- `modules/payments` ä¸“æ³¨å¤„ç†ç¬¬ä¸‰æ–¹å›è°ƒï¼ˆXML éªŒç­¾ã€çŠ¶æ€æ›´æ–°ï¼‰ã€‚

**2. ç‹¬ç«‹èµ„äº§åŸŸ**  
- `modules/assets` æš´éœ²ä½™é¢/æµæ°´æŸ¥è¯¢æ¥å£ï¼›æ‰€æœ‰æ‰£å‡ã€å¢åŠ å‡ç”± OrderService åœ¨äº‹åŠ¡ä¸­è°ƒç”¨èµ„äº§æœåŠ¡ã€‚

**3. å…¨å±€åŸºåº§**  
- `global.module.ts` åˆ©ç”¨ @Global() æš´éœ²æ‰€æœ‰ factoriesï¼Œä»»ä½• controller åªéœ€å£°æ˜ä¾èµ–å³å¯æ‹¿åˆ° `packages/services` ä¸­çš„ä¸šåŠ¡ç±»ã€‚

**4. é€šç”¨åˆ‡é¢**  
- `xml-body.middleware.ts` ä»…å¯¹ `/payments/callback/wechat` å¯ç”¨ï¼Œç¡®ä¿å…¨å±€ä»ç„¶ä½¿ç”¨ JSONã€‚  
- ç»Ÿä¸€çš„æ‹¦æˆªå™¨è¾“å‡º `{ code: 0, data }`ï¼Œæ‰€æœ‰å¼‚å¸¸è¿‡æ»¤å™¨è½åˆ° `error-codes.ts` ç»´æŠ¤çš„ä¸šåŠ¡ç¼–å·ã€‚

---

## 6. å…³é”®ä¸šåŠ¡æ¨¡å—å®ç°æ–¹æ¡ˆ

### 5.1 æ•°æ®æµæ¶æ„ (Drizzle -> Zod -> Next/Hono)

**åŸºç¡€ç”¨æˆ·æ•°æ®æµç¤ºä¾‹ï¼š**

```typescript
// 1. Database Schema (packages/db/src/schema/users.ts)
export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  wxOpenId: varchar('wx_openid', { length: 128 }).notNull().unique(),
  nickname: varchar('nickname', { length: 50 }),
  location: geometry('location', { type: 'point', srid: 4326 }),
  creditScore: integer('credit_score').default(100),
  createdAt: timestamp('created_at').defaultNow(),
});

// 2. Zod Schema for validation (packages/services/users/validation.ts)
export const userSchema = z.object({
  wxOpenId: z.string().min(1).max(128),
  nickname: z.string().min(1).max(50).optional(),
  location: z.object({ lat: z.number(), lng: z.number() }).optional(),
});

// 3. Service Layer (packages/services/users/service.ts)
export class UserService {
  async createUser(data: z.infer<typeof userSchema>) {
    const validated = userSchema.parse(data);
    return await db.insert(users).values({
      wxOpenId: validated.wxOpenId,
      nickname: validated.nickname,
      location: validated.location ? `POINT(${validated.location.lng} ${validated.location.lat})` : null,
    }).returning();
  }
}

// 4. API Layer (apps/api/src/routes/users.ts or apps/web/app/api/users/route.ts)
app.post('/api/users', async (c) => {
  const data = await c.req.json();
  const userService = new UserService();
  const user = await userService.createUser(data);
  return c.json(user);
});
```

**èµ„äº§ä½“ç³»æ•°æ®æµç¤ºä¾‹ï¼ˆåŒè´¦æœ¬è®¾è®¡ï¼‰ï¼š**

```typescript
// 1. Database Schema (packages/db/src/schema/user_assets.ts & asset_records.ts)
export const userAssets = pgTable('user_assets', {
  userId: uuid('user_id').notNull().references(() => users.id),
  assetId: assetIdEnum('asset_id').notNull(), // 'coin', 'point', 'speed_match_card' ç­‰
  category: assetCategoryEnum('category').notNull(), // 'currency', 'consumable', 'badge'
  balance: integer('balance').notNull().default(0),
  metadata: jsonb('metadata'),
}, (t) => [
  primaryKey({ columns: [t.userId, t.assetId] }),
]);

export const assetRecords = pgTable('asset_records', {
  id: bigint('id', { mode: 'number' }).primaryKey().generatedAlwaysAsIdentity(),
  userId: uuid('user_id').notNull().references(() => users.id),
  assetId: assetIdEnum('asset_id').notNull(),
  amount: integer('amount').notNull(), // æ­£æ•°ä¸ºè·å–ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè€—
  balanceSnapshot: integer('balance_snapshot').notNull(), // å˜åŠ¨åçš„ä½™é¢å¿«ç…§
  reason: assetChangeReasonEnum('reason').notNull(), // 'recharge', 'payment_use', 'check_in' ç­‰
  relatedOrderId: uuid('related_order_id').references(() => orders.id),
  description: text('description'),
  createdAt: timestamp('created_at').defaultNow(),
});

// 2. Zod Schema for validation (packages/services/economy/validation.ts)
export const rechargeSchema = z.object({
  productId: z.string().uuid(),
  paymentMethod: z.enum(['wechat', 'asset']),
});

// 3. Service Layer (packages/services/economy/service.ts)
export class EconomyService {
  async recharge(userId: string, data: z.infer<typeof rechargeSchema>) {
    const validated = rechargeSchema.parse(data);
    
    // äº‹åŠ¡å¤„ç†ï¼šåˆ›å»ºè®¢å• -> æ”¯ä»˜ -> å¢åŠ èµ„äº§ -> è®°å½•æµæ°´
    return await db.transaction(async (tx) => {
      // 1. æŸ¥è¯¢å•†å“ä¿¡æ¯
      const product = await tx.select().from(products).where(eq(products.id, validated.productId));
      if (!product[0]) throw new Error('Product not found');
      
      // 2. åˆ›å»ºè®¢å•
      const order = await tx.insert(orders).values({
        userId,
        productId: validated.productId,
        paymentMethod: validated.paymentMethod,
        status: 'pending',
      }).returning();
      
      // 3. å¤„ç†æ”¯ä»˜ï¼ˆå¾®ä¿¡æ”¯ä»˜æˆ–èµ„äº§æ”¯ä»˜ï¼‰
      if (validated.paymentMethod === 'wechat') {
        // åˆ›å»ºæ”¯ä»˜è®°å½•ï¼Œç­‰å¾…å›è°ƒ
        await tx.insert(payments).values({
          orderId: order[0].id,
          userId,
          amount: product[0].priceCny || 0,
          status: 'pending',
        });
      } else {
        // èµ„äº§æ”¯ä»˜ï¼šæ‰£é™¤èµ„äº§ä½™é¢
        await this.deductAsset(tx, userId, product[0].priceAssetId!, product[0].priceAssetAmount!);
      }
      
      // 4. æ”¯ä»˜æˆåŠŸåï¼Œæ ¹æ®å•†å“é…ç½®å¢åŠ èµ„äº§
      const config = product[0].config as { assets: Array<{ id: string; amount: number }> };
      
      for (const asset of config.assets) {
        await this.addAsset(tx, userId, asset.id, asset.amount, 'recharge', order[0].id);
      }
      
      return order[0];
    });
  }
  
  private async addAsset(tx: any, userId: string, assetId: string, amount: number, reason: string, orderId?: string) {
    // æ›´æ–°æˆ–æ’å…¥ä½™é¢
    await tx.insert(userAssets).values({
      userId,
      assetId,
      category: this.getCategory(assetId),
      balance: amount,
    }).onConflictDoUpdate({
      target: [userAssets.userId, userAssets.assetId],
      set: { balance: sql`${userAssets.balance} + ${amount}` },
    });
    
    // è·å–æœ€æ–°ä½™é¢ä½œä¸ºå¿«ç…§
    const latest = await tx.select().from(userAssets)
      .where(and(eq(userAssets.userId, userId), eq(userAssets.assetId, assetId)));
    const balanceSnapshot = latest[0]?.balance || amount;
    
    // æ’å…¥æµæ°´è®°å½•
    await tx.insert(assetRecords).values({
      userId,
      assetId,
      amount,
      balanceSnapshot,
      reason,
      relatedOrderId: orderId,
    });
  }
}

// 4. API Layer (apps/api/src/routes/economy.ts)
app.post('/api/economy/recharge', async (c) => {
  const userId = c.get('userId'); // ä»è®¤è¯ä¸­é—´ä»¶è·å–
  const data = await c.req.json();
  const economyService = new EconomyService();
  const order = await economyService.recharge(userId, data);
  return c.json(order);
});
```

### 5.2 åŸç”Ÿå°ç¨‹åºå·¥ç¨‹åŒ– (Native + Vite)

- **ç—›ç‚¹è§£å†³**ï¼šåŸç”Ÿå°ç¨‹åºç¼ºä¹ npm æ”¯æŒã€ç¼ºä¹ TS æ”¯æŒã€æ„å»ºæ…¢ã€‚
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - **æ„å»º**ï¼š`vite.config.ts` ä¸­å¼•å…¥ `weapp-vite` æ’ä»¶ã€‚
  - **æºç å¼•ç”¨**ï¼šé…ç½® `resolve.alias` å°† `@juchang/services` æŒ‡å‘ `../../packages/services/src/index.ts`ã€‚
  - **æ•ˆæœ**ï¼šVite è‡ªåŠ¨å°† TS ç¼–è¯‘ä¸º JSï¼Œå°† npm åŒ…æ‰“åŒ…è¿› `miniprogram_npm` (æˆ–å†…è”)ï¼Œå¹¶å¤„ç† Tree-shakingã€‚
  - **çƒ­æ›´æ–°**ï¼šä¿®æ”¹ `packages` é‡Œçš„ä»£ç ï¼Œå°ç¨‹åºæ¨¡æ‹Ÿå™¨ç§’çº§åˆ·æ–°ã€‚

### 5.3 Next.js Webåº”ç”¨ (App Router)

- **æœåŠ¡ç«¯æ¸²æŸ“**ï¼šåˆ©ç”¨Next.js 15çš„App Routerå®ç°ä¼˜ç§€çš„SEOå’Œé¦–å±æ€§èƒ½
- **API Routes**ï¼šå†…ç½®APIè·¯ç”±ï¼Œå¯ç›´æ¥è°ƒç”¨serviceså±‚
- **å…¨æ ˆç±»å‹å®‰å…¨**ï¼šä»æ•°æ®åº“åˆ°å‰ç«¯ï¼Œå®Œæ•´çš„TypeScriptæ”¯æŒ
- **éƒ¨ç½²ä¼˜åŒ–**ï¼šæ”¯æŒEdge Runtimeï¼Œä¸Hono APIå…±äº«è¿è¡Œæ—¶ç¯å¢ƒ

### 5.4 LBS ç¤¾äº¤ä¸â€œå¥¹æ¨¡å¼â€ (PostGIS)

- **å­˜å‚¨**ï¼š`packages/db` å®šä¹‰ geometry å­—æ®µã€‚
- **é€»è¾‘ (`packages/services/lbs.ts`)**ï¼š
  - **é™„è¿‘æŸ¥è¯¢**ï¼šå°è£… `ST_DWithin` SQL æŸ¥è¯¢ã€‚
  - **å¥¹æ¨¡å¼ (She-Mode)**ï¼š
    - å‰ç«¯ï¼šå°ç¨‹åºå¼€å…³è§¦å‘ï¼Œä¼ å…¥ `sheMode=true` å‚æ•°ã€‚
    - åç«¯ï¼ˆShared Serviceï¼‰ï¼š
      ```typescript
      if (params.sheMode) {
        sql.where(
          and(
            eq(activity.riskLevel, 'low'), // è¿‡æ»¤é«˜é£é™©
            gte(activity.femaleParticipants, 3) // ä»…æ˜¾ç¤ºå¥³æ€§å‹å¥½
          )
        );
      }
      ```

### 5.5 èµ„äº§ä½“ç³»ä¸åŒè´¦æœ¬è®¾è®¡

- **è®¾è®¡åŸåˆ™**ï¼šå¤šèµ„äº§ç±»å‹ + åŒè´¦æœ¬å®¡è®¡ï¼ˆä½™é¢è´¦æœ¬ + æµæ°´è´¦æœ¬ï¼‰ã€‚
- **æ ¸å¿ƒè¡¨ç»“æ„**ï¼š
  - `user_assets` - **ä½™é¢è´¦æœ¬**ï¼šå­˜å‚¨ç”¨æˆ·å½“å‰èµ„äº§ä½™é¢ï¼ˆæ”¯æŒå¤šç§èµ„äº§ï¼šé‡‘å¸ã€ç§¯åˆ†ã€é“å…·å¡ç­‰ï¼‰
  - `asset_records` - **æµæ°´è´¦æœ¬**ï¼šè®°å½•æ‰€æœ‰èµ„äº§å˜åŠ¨å†å²ï¼ˆå¸¦ä½™é¢å¿«ç…§ï¼Œç”¨äºè´¢åŠ¡å®¡è®¡ï¼‰
  - `orders` - **ä¸šåŠ¡è®¢å•**ï¼šç»Ÿä¸€è®¢å•å…¥å£ï¼Œæ”¯æŒæ³•å¸æ”¯ä»˜å’Œèµ„äº§æ”¯ä»˜
  - `payments` - **æ”¯ä»˜æµæ°´**ï¼šä¸“é—¨å¤„ç†å¤–éƒ¨æ”¯ä»˜ç½‘å…³ï¼ˆå¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ç­‰ï¼‰
  - `products` - **å•†å“å®šä¹‰**ï¼šæ”¯æŒæ³•å¸å®šä»·å’Œèµ„äº§å®šä»·ï¼Œå®šä¹‰äº¤ä»˜å†…å®¹

- **èµ„äº§ç±»å‹ä½“ç³»**ï¼š
  - **è´§å¸ç±»**ï¼š`coin` (é‡‘å¸)ã€`point` (ç§¯åˆ†)
  - **é“å…·ç±»**ï¼š`speed_match_card` (åŠ é€ŸåŒ¹é…å¡)ã€`super_like` (è¶…çº§å–œæ¬¢)ã€`activity_top_card` (æ´»åŠ¨ç½®é¡¶å¡) ç­‰
  - **æƒç›Šç±»**ï¼š`early_bird_badge` (æ—©é¸Ÿå¾½ç« )ã€`verified_badge` (è®¤è¯æ ‡è¯†) ç­‰

- **ä¸šåŠ¡æµç¨‹ (`packages/services/economy.ts`)**ï¼š
  - **å……å€¼æµç¨‹**ï¼š
    1. ç”¨æˆ·é€‰æ‹©å•†å“ï¼ˆå¦‚"100é‡‘å¸åŒ…"ï¼‰-> åˆ›å»º `orders` è®¢å•
    2. å‘èµ·å¾®ä¿¡æ”¯ä»˜ -> åˆ›å»º `payments` æ”¯ä»˜è®°å½•
    3. æ”¯ä»˜å›è°ƒæˆåŠŸ -> æ›´æ–° `payments.status = 'success'`
    4. äº‹åŠ¡å¤„ç†ï¼š
       - æ›´æ–° `orders.status = 'paid'`
       - æ ¹æ® `products.config` å¢åŠ  `user_assets` å¯¹åº”èµ„äº§ä½™é¢
       - æ’å…¥ `asset_records` æµæ°´è®°å½•ï¼ˆå¸¦ä½™é¢å¿«ç…§ï¼‰
  
  - **èµ„äº§æ”¯ä»˜æµç¨‹**ï¼ˆå¦‚ç”¨é‡‘å¸ä¹°AIæœåŠ¡ï¼‰ï¼š
    1. ç”¨æˆ·é€‰æ‹©å•†å“ -> åˆ›å»º `orders` è®¢å•ï¼ˆ`paymentMethod = 'asset'`ï¼‰
    2. äº‹åŠ¡å¤„ç†ï¼š
       - æ‰£é™¤ `user_assets` å¯¹åº”èµ„äº§ä½™é¢ï¼ˆå¦‚ `coin`ï¼‰
       - æ’å…¥ `asset_records` æ¶ˆè€—æµæ°´
       - æ›´æ–° `orders.status = 'paid'`
    3. æ ¹æ®å•†å“ç±»å‹æ‰§è¡Œäº¤ä»˜é€»è¾‘ï¼ˆå¦‚æ”¾è¡ŒAIè¯·æ±‚ã€å‘æ”¾é“å…·ç­‰ï¼‰
  
  - **èµ„äº§å˜åŠ¨å®¡è®¡**ï¼š
    - æ¯æ¬¡å˜åŠ¨éƒ½è®°å½• `asset_records.balanceSnapshot`ï¼ˆå˜åŠ¨åçš„ä½™é¢ï¼‰
    - è´¢åŠ¡å¯¹è´¦æ—¶å¯é€šè¿‡å¿«ç…§éªŒè¯ä½™é¢ä¸€è‡´æ€§ï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹
    - æ”¯æŒæŒ‰ `reason`ï¼ˆå˜åŠ¨åŸå› ï¼‰åˆ†ç±»æŸ¥è¯¢ï¼šå……å€¼ã€ç­¾åˆ°ã€æ¶ˆè´¹ã€é€€æ¬¾ç­‰

- **å®ç°ä½ç½®**ï¼šæ­¤é€»è¾‘åœ¨ **Hono API** ä¸­è°ƒç”¨ï¼Œæ‰€æœ‰èµ„äº§æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿åŸå­æ€§ã€‚

### 5.6 AI æµå¼å¯¹è¯ (Streamed SSE)

- **åœºæ™¯**ï¼šAI åŠ©æ‰‹é¡µã€æ´»åŠ¨ç­–åˆ’ã€‚
- **å®ç°**ï¼š
  - å°ç¨‹åºï¼šä½¿ç”¨ `wx.request` çš„ `enableChunked: true` æ¥æ”¶æµã€‚
  - Next.js/Hono APIï¼šä½¿ç”¨ `streamText` è¿”å› SSE (Server-Sent Events)ã€‚
  - Promptï¼šåœ¨ `packages/services/ai.ts` ä¸­é¢„è®¾ Prompt æ¨¡æ¿ï¼Œä¸æš´éœ²ç»™å‰ç«¯ã€‚

---

## 6. æ•°æ®ä¸å®‰å…¨æ¶æ„

### 6.1 æ•°æ®åº“ Schema (Drizzle + Zod)

æ•°æ®åº“å±‚é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ‰€æœ‰è¡¨å®šä¹‰ä½äº `packages/db/src/schema/` ç›®å½•ä¸‹ï¼š

**Schema æ–‡ä»¶ç»“æ„ï¼š**
- `enums.ts` - æšä¸¾ç±»å‹å®šä¹‰ï¼ˆç”¨æˆ·æ€§åˆ«ã€ä¼šå‘˜ç±»å‹ã€è®¢å•çŠ¶æ€ã€æ”¯ä»˜æ–¹å¼ç­‰ï¼‰
- `users.ts` - ç”¨æˆ·è¡¨ï¼ˆè®¤è¯ã€èµ„æ–™ã€èµ„äº§ã€ä¼šå‘˜ã€ä¿¡ç”¨ç­‰ï¼‰
- `activities.ts` - æ´»åŠ¨è¡¨ï¼ˆLBS åœ°ç†ä½ç½®ã€å‚ä¸è€…è§„åˆ™ã€é£æ§ç­‰ï¼‰
- `participants.ts` - å‚ä¸è€…è¡¨ï¼ˆæ´»åŠ¨æŠ¥åå…³ç³»ï¼‰
- `orders.ts` - è®¢å•è¡¨ï¼ˆå•†å“å¿«ç…§ã€æ”¯ä»˜ä¿¡æ¯ã€çŠ¶æ€æµè½¬ï¼‰
- `products.ts` - å•†å“è¡¨ï¼ˆé‡‘å¸åŒ…ã€ä¼šå‘˜å¡ã€AIæœåŠ¡ã€è™šæ‹Ÿç¤¼ç‰©ç­‰ï¼‰
- `payments.ts` - æ”¯ä»˜è¡¨ï¼ˆå¾®ä¿¡æ”¯ä»˜æµæ°´ã€å›è°ƒè®°å½•ï¼‰
- `user_assets.ts` - ç”¨æˆ·èµ„äº§è¡¨ï¼ˆé‡‘å¸ä½™é¢ã€ä¼šå‘˜çŠ¶æ€ç­‰ï¼‰
- `asset_records.ts` - èµ„äº§è®°å½•è¡¨ï¼ˆé‡‘å¸å˜åŠ¨æµæ°´ã€ä½™é¢å¿«ç…§ï¼‰

**ç¤ºä¾‹ä»£ç ï¼š**

```typescript
// packages/db/src/schema/activities.ts
export const activities = pgTable('activities', {
  id: uuid('id').primaryKey().defaultRandom(),
  title: varchar('title', { length: 100 }).notNull(),
  location: geometry('location', { type: 'point', srid: 4326 }).notNull(), // PostGIS
  isFemaleFriendly: boolean('is_female_friendly').default(false),
  status: varchar('status', { length: 20 }).default('active'), // active, cancelled, completed
  riskLevel: varchar('risk_level', { length: 10 }).default('low'),
  hostId: uuid('host_id').notNull().references(() => users.id),
  createdAt: timestamp('created_at').defaultNow(),
});

// packages/db/src/db.ts - æ•°æ®åº“å®¢æˆ·ç«¯åˆå§‹åŒ–
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

export const db = drizzle(client, { schema });

// Zod validation schema (ä½äº packages/services å±‚)
export const activitySchema = z.object({
  title: z.string().min(1).max(100),
  location: z.object({ lat: z.number(), lng: z.number() }),
  type: z.enum(['food', 'sports', 'culture', 'entertainment', 'travel', 'study']),
  maxParticipants: z.number().min(2).max(20),
});
```

### 6.2 å†…å®¹å®‰å…¨é£æ§ (çº¢çº¿)

- **æ‹¦æˆªæœºåˆ¶**ï¼šåœ¨ `packages/services` å±‚å°è£… `checkContent(text, image)`ã€‚
- **å¼ºåˆ¶æ‰§è¡Œ**ï¼š
  - åˆ›å»ºæ´»åŠ¨ API
  - ä¿®æ”¹èµ„æ–™ API
  - å‘å¸ƒè¯„è®º API
  - **å¿…é¡»**å…ˆ `await checkContent()`ï¼Œé€šè¿‡åæ‰èƒ½å†™å…¥æ•°æ®åº“ã€‚

---

## 7. å¼€å‘ä¸æ„å»ºæµç¨‹

### 7.1 å¼€å‘ç¯å¢ƒ (Dev)

**å‘½ä»¤**ï¼š`pnpm dev` (æ ¹ç›®å½•)

1.  **Turbo** å¹¶è¡Œå¯åŠ¨ä»»åŠ¡ã€‚
2.  **Hono API**: `tsx watch` å¯åŠ¨ï¼Œç›´æ¥è¿è¡Œ TSã€‚
3.  **Next.js Web**: `next dev` å¯åŠ¨ï¼Œæ”¯æŒApp Routerå’ŒAPI Routesã€‚
4.  **Miniprogram**: `weapp-vite` å¯åŠ¨ï¼Œç›‘å¬æ–‡ä»¶å˜åŒ– -> ç¼–è¯‘åŸç”Ÿä»£ç  -> è¾“å‡ºåˆ° `dist/`ã€‚
5.  **å¼€å‘è€…å·¥å…·**ï¼šå¼€å‘è€…åªéœ€æ‰“å¼€ `apps/miniprogram/dist`ï¼Œå³å¯çœ‹åˆ°å®æ—¶æ•ˆæœã€‚

### 7.2 ç”Ÿäº§éƒ¨ç½² (Build)

**å‘½ä»¤**ï¼š`pnpm build`

1.  **Next.js**: æ„å»ºä¼˜åŒ–åçš„ç”Ÿäº§åŒ…ï¼Œæ”¯æŒEdge Runtimeã€‚
2.  **Hono API**: æ„å»º Docker é•œåƒï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨æˆ–Edgeå¹³å°ã€‚
3.  **Miniprogram**: `weapp-vite` æ‰§è¡Œç”Ÿäº§æ„å»ºï¼ˆå‹ç¼©ã€å»æ— ç”¨ä»£ç ï¼‰ï¼Œç”Ÿæˆä¼˜åŒ–åçš„ `dist` åŒ… -> ä¸Šä¼ å¾®ä¿¡åå°ã€‚

---

## 8. ç¯å¢ƒå˜é‡ç®¡ç†

### 8.1 æ ¹ç›®å½•ç¯å¢ƒå˜é‡ (.env.example)

```bash
# Database
DATABASE_URL=postgresql://postgres:password@localhost:5432/juchang

# Redis
REDIS_URL=redis://localhost:6379

# API
API_PORT=3000
NEXT_PUBLIC_API_URL=http://localhost:3000

# WeChat
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret

# AI
AI_API_KEY=your_ai_api_key
```

### 8.2 Dockerç¯å¢ƒå˜é‡ (docker/.env.example)

```bash
# PostgreSQL
POSTGRES_DB=juchang
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_secure_password_here
POSTGRES_PORT=5432

# Redis
REDIS_PORT=6379
```

---

## 9. æ€»ç»“

è¿™å¥—æ¶æ„æ–¹æ¡ˆå®Œç¾å¥‘åˆäº†**â€œç°ä»£åŒ–å…¨æ ˆå¼€å‘â€**çš„éœ€æ±‚ï¼š

1.  **Next.js 15**: æä¾›å“è¶Šçš„Webä½“éªŒå’Œå…¨æ ˆå¼€å‘èƒ½åŠ›
2.  **Drizzle ORM + Zod**: å®ç°ä»æ•°æ®åº“åˆ°APIçš„å®Œæ•´ç±»å‹å®‰å…¨
3.  **åŸç”Ÿå°ç¨‹åº**: ä¿æŒæè‡´çš„ç§»åŠ¨ç«¯æ€§èƒ½
4.  **Turborepo + Internal Packages**: å®ç°çœŸæ­£çš„å…¨æ ˆé€»è¾‘å¤ç”¨
5.  **Hono + PostGIS**: æœåŠ¡ç«¯è½»é‡ä¸”å¼ºå¤§ï¼Œå®Œç¾æ”¯æ’‘LBSä¸šåŠ¡

è¿™æ˜¯ä¸€ä¸ª**ç°ä»£åŒ–ã€é«˜æ€§èƒ½ã€ç±»å‹å®‰å…¨ã€æ˜“äºç»´æŠ¤**çš„å·¥ä¸šçº§å…¨æ ˆæ¶æ„ã€‚
