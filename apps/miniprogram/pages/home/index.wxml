<!--
  首页（地图 + AI输入栏）
  Requirements: 1.1, 1.2, 2.1-2.6, 3.1-3.7, 4.1-4.7, 5.1-5.4
-->
<view class="relative w-full h-screen">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading-overlay">
    <t-loading theme="circular" size="80rpx" text="定位中..." />
  </view>

  <!-- 全屏地图 -->
  <map
    id="map"
    class="w-full h-full"
    latitude="{{latitude}}"
    longitude="{{longitude}}"
    scale="{{scale}}"
    markers="{{markers}}"
    show-location="{{locationAuthorized}}"
    enable-zoom="{{true}}"
    enable-scroll="{{true}}"
    enable-rotate="{{false}}"
    bindmarkertap="onMarkerTap"
    bindregionchange="onRegionChange"
  />

  <!-- 浮动按钮组件 -->
  <floating-buttons bind:locationtap="onLocationTap" bind:safetytap="onSafetyTap" />

  <!-- AI 输入栏 -->
  <ai-input-bar
    id="aiInputBar"
    placeholder="本周想玩什么..."
    prefill-text="{{aiPrefillText}}"
    prefill-type="{{aiPrefillType}}"
    prefill-location="{{aiPrefillLocation}}"
    bind:expand="onAIInputExpand"
    bind:collapse="onAIInputCollapse"
    bind:parse="onAIParse"
  />

  <!-- 底部抽屉组件 -->
  <bottom-drawer
    filter-count="{{filterCount}}"
    activity-count="{{activityCount}}"
    loading="{{activitiesLoading}}"
    bind:filtertap="onFilterTap"
    bind:createtap="onCreateActivity"
    bind:expand="onDrawerExpand"
    bind:collapse="onDrawerCollapse"
  >
    <view slot="activities">
      <block wx:for="{{nearbyActivities}}" wx:key="id">
        <activity-card activity="{{item}}" mode="list" show-distance="{{true}}" bind:tap="onActivityListItemTap" data-activity="{{item}}" />
      </block>
      <view wx:if="{{nearbyActivities.length === 0 && !activitiesLoading}}" class="flex flex-col items-center justify-center py-8">
        <t-icon name="map" size="80rpx" color="#ccc" />
        <text class="mt-3 text-base text-gray-400">附近暂无活动</text>
        <text class="mt-1 text-sm text-gray-300">成为第一个发起活动的人吧！</text>
      </view>
    </view>
  </bottom-drawer>

  <!-- 活动卡片弹窗 -->
  <view wx:if="{{showActivityCard}}" class="activity-card-overlay" bindtap="onCloseActivityCard">
    <view class="activity-card-popup" catchtap="">
      <activity-card activity="{{selectedActivity}}" mode="popup" show-distance="{{true}}" bind:tap="onActivityCardTap" />
      <view wx:if="{{selectedActivity.isBoosted}}" class="boost-badge">
        <text>🔥</text>
        <text class="text-xs text-white font-semibold ml-1">急招</text>
      </view>
    </view>
  </view>

  <!-- 筛选面板 -->
  <filter-panel visible="{{showFilterPanel}}" filters="{{filters}}" bind:close="onFilterPanelClose" bind:apply="onFilterApply" />

  <!-- CUI 副驾面板 -->
  <cui-panel id="cuiPanel" visible="{{showCUIPanel}}" bind:close="onCUIPanelClose" bind:location="onCUILocation" bind:selectActivities="onCUISelectActivities" bind:createDraft="onCUICreateDraft" />
</view>
