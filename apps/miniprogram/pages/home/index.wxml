<!--
  首页 (Chat-First 架构)
  Requirements: 1.1, 1.2, 1.3, 1.4, 3.2
  v3.7 重构: 使用 useChatStore，支持 UIMessage.parts 渲染
  
  三层结构：Custom_Navbar + Chat_Stream + AI_Dock
  - 首次进入显示 Widget_Dashboard
  - 空气感渐变背景
-->
<view class="home-page">
  <!-- 网络状态通知条 -->
  <network-status bind:retry="onNetworkRetry" />
  
  <!-- 空气感渐变背景 -->
  <view class="atmospheric-bg"></view>
  
  <!-- 自定义导航栏 -->
  <custom-navbar 
    title="聚场"
    showMenu="{{true}}"
    showMore="{{true}}"
    bind:newchat="onNewChat"
  />
  
  <!-- 对话流容器 -->
  <scroll-view
    class="chat-stream-container"
    scroll-y
    scroll-with-animation
    scroll-into-view="{{scrollToView}}"
    enhanced
    show-scrollbar="{{false}}"
  >
    <!-- 消息列表 -->
    <view class="message-list">
      <block wx:for="{{messages}}" wx:key="id">
        <view 
          id="msg-{{item.id}}"
          class="message-item message-item--{{item.role}} {{index >= messages.length - 3 ? 'slide-up-fade-in' : ''}}"
          style="animation-delay: {{(index - (messages.length - 3)) * 50}}ms;"
        >
          <!-- 用户消息 -->
          <block wx:if="{{item.role === 'user'}}">
            <block wx:for="{{item.parts}}" wx:for-item="part" wx:key="index">
              <block wx:if="{{part.type === 'text'}}">
                <message-bubble 
                  role="user" 
                  content="{{part.text}}"
                />
              </block>
            </block>
          </block>
          
          <!-- AI 消息 - 遍历 parts 渲染 -->
          <block wx:else>
            <block wx:for="{{item.parts}}" wx:for-item="part" wx:for-index="partIndex" wx:key="partIndex">
              <!-- 文本消息 -->
              <block wx:if="{{part.type === 'text'}}">
                <message-bubble 
                  role="assistant" 
                  content="{{part.text}}"
                  isStreaming="{{streamingMessageId === item.id}}"
                />
              </block>
              
              <!-- Widget 消息 -->
              <block wx:elif="{{part.type === 'widget'}}">
                <!-- Widget_Dashboard -->
                <block wx:if="{{part.widgetType === 'dashboard'}}">
                  <widget-dashboard 
                    nickname="{{part.data.nickname || userNickname}}"
                    activities="{{part.data.activities}}"
                    greeting="{{part.data.greeting}}"
                    quickActions="{{part.data.quickActions}}"
                    fallbackPrompt="{{part.data.fallbackPrompt}}"
                    bind:activitytap="onDashboardActivityTap"
                    bind:prompttap="onDashboardPromptTap"
                    bind:quickactiontap="onDashboardQuickActionTap"
                    bind:explorenearby="onDashboardExploreNearby"
                    bind:findpartner="onDashboardFindPartner"
                  />
                </block>
                
                <!-- Widget_Draft -->
                <block wx:elif="{{part.widgetType === 'draft'}}">
                  <widget-draft 
                    draft="{{part.data}}"
                    bind:confirm="onDraftConfirm"
                    bind:adjustlocation="onDraftAdjustLocation"
                    bind:sendMessage="onDraftSendMessage"
                  />
                </block>
                
                <!-- Widget_Share -->
                <block wx:elif="{{part.widgetType === 'share'}}">
                  <widget-share 
                    activity="{{part.data}}"
                    bind:share="onWidgetShareTap"
                  />
                </block>
                
                <!-- Widget_Explore -->
                <block wx:elif="{{part.widgetType === 'explore'}}">
                  <widget-explore 
                    results="{{part.data.results}}"
                    center="{{part.data.center}}"
                    title="{{part.data.title}}"
                    bind:expandmap="onExploreExpandMap"
                  />
                </block>
                
                <!-- Widget_Ask_Preference -->
                <block wx:elif="{{part.widgetType === 'ask_preference'}}">
                  <widget-ask-preference 
                    questionType="{{part.data.questionType}}"
                    question="{{part.data.question}}"
                    options="{{part.data.options}}"
                    allowSkip="{{part.data.allowSkip}}"
                    collectedInfo="{{part.data.collectedInfo}}"
                    disabled="{{part.data.disabled}}"
                    bind:select="onAskPreferenceSelect"
                    bind:skip="onAskPreferenceSkip"
                  />
                </block>
                
                <!-- Widget_Error -->
                <block wx:elif="{{part.widgetType === 'error'}}">
                  <widget-error 
                    message="{{part.data.message || '出了点问题'}}"
                    showRetry="{{part.data.showRetry !== false}}"
                    data-original-text="{{part.data.originalText}}"
                    bind:retry="onWidgetErrorRetry"
                  />
                </block>
              </block>
            </block>
          </block>
        </view>
      </block>
    </view>
    
    <!-- AI 思考态 - 当 status 为 submitted 时显示 -->
    <view wx:if="{{status === 'submitted'}}" class="message-item message-item--assistant slide-up-fade-in">
      <thinking-bubble text="收到，小聚正在整理你的安排..." />
    </view>
    
    <!-- 底部占位（为 AI Dock 留空间） -->
    <view class="bottom-spacer"></view>
  </scroll-view>
  
  <!-- AI Dock (超级输入坞) -->
  <ai-dock 
    id="aiDock"
    placeholder="粘贴文字，或直接告诉我..."
    bind:send="onSend"
    bind:parse="onParse"
    bind:paste="onPaste"
  />
  
  <!-- 手机号绑定半屏 -->
  <auth-sheet 
    show="{{isAuthSheetVisible}}"
    bind:success="onAuthSuccess"
    bind:pendingaction="onPendingAction"
  />
  
  <!-- 分享引导蒙层 -->
  <share-guide 
    show="{{isShareGuideVisible}}"
    title="{{shareGuideData.title}}"
    mapUrl="{{shareGuideData.mapUrl}}"
  />
</view>
