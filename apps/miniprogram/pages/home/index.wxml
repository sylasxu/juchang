<!--
  首页 (Chat-First 架构)
  Requirements: 1.1, 1.2, 1.3, 1.4, 3.2
  
  三层结构：Custom_Navbar + Chat_Stream + AI_Dock
  - 首次进入显示 Widget_Dashboard
  - 空气感渐变背景
-->
<view class="home-page">
  <!-- 网络状态通知条 -->
  <network-status bind:retry="onNetworkRetry" />
  
  <!-- 空气感渐变背景 -->
  <view class="atmospheric-bg"></view>
  
  <!-- 自定义导航栏 -->
  <custom-navbar 
    title="聚场"
    showMenu="{{true}}"
    showMore="{{true}}"
    bind:newchat="onNewChat"
  />
  
  <!-- 对话流容器 -->
  <scroll-view
    class="chat-stream-container"
    scroll-y
    scroll-with-animation
    scroll-into-view="{{scrollToView}}"
    upper-threshold="100"
    bindscrolltoupper="onLoadMore"
    enhanced
    show-scrollbar="{{false}}"
  >
    <!-- 加载更多指示器 -->
    <view wx:if="{{isLoadingMore}}" class="loading-more">
      <view class="loading-dots">
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
      </view>
    </view>
    
    <!-- 消息列表 -->
    <view class="message-list">
      <block wx:for="{{messages}}" wx:key="id">
        <view 
          id="msg-{{item.id}}"
          class="message-item message-item--{{item.role}} {{index >= messages.length - 3 ? 'slide-up-fade-in' : ''}}"
          style="animation-delay: {{(index - (messages.length - 3)) * 50}}ms;"
        >
          <!-- 用户消息 -->
          <block wx:if="{{item.role === 'user'}}">
            <message-bubble 
              role="user" 
              content="{{item.content.text || item.content}}"
            />
          </block>
          
          <!-- AI 消息 -->
          <block wx:else>
            <!-- 文本消息 -->
            <block wx:if="{{item.type === 'text'}}">
              <message-bubble 
                role="assistant" 
                content="{{item.content.text || item.content}}"
              />
            </block>
            
            <!-- Widget_Dashboard -->
            <block wx:elif="{{item.type === 'widget_dashboard'}}">
              <widget-dashboard 
                nickname="{{item.content.nickname || userNickname}}"
                activities="{{item.content.activities || upcomingActivities}}"
                greeting="{{item.content.greeting}}"
                quickActions="{{item.content.quickActions}}"
                fallbackPrompt="{{item.content.fallbackPrompt}}"
                bind:activitytap="onDashboardActivityTap"
                bind:prompttap="onDashboardPromptTap"
                bind:quickactiontap="onDashboardQuickActionTap"
                bind:explorenearby="onDashboardExploreNearby"
                bind:findpartner="onDashboardFindPartner"
              />
            </block>
            
            <!-- Widget_Draft -->
            <block wx:elif="{{item.type === 'widget_draft'}}">
              <widget-draft 
                draft="{{item.content}}"
                bind:confirm="onDraftConfirm"
                bind:adjustlocation="onDraftAdjustLocation"
                bind:sendMessage="onDraftSendMessage"
              />
            </block>
            
            <!-- Widget_Share -->
            <block wx:elif="{{item.type === 'widget_share'}}">
              <widget-share 
                activity="{{item.content}}"
                bind:share="onWidgetShareTap"
              />
            </block>
            
            <!-- Widget_Explore -->
            <block wx:elif="{{item.type === 'widget_explore'}}">
              <widget-explore 
                results="{{item.content.results}}"
                center="{{item.content.center}}"
                title="{{item.content.title}}"
                bind:expandmap="onExploreExpandMap"
              />
            </block>
            
            <!-- Widget_Ask_Preference -->
            <block wx:elif="{{item.type === 'widget_ask_preference'}}">
              <widget-ask-preference 
                questionType="{{item.content.questionType}}"
                question="{{item.content.question}}"
                options="{{item.content.options}}"
                allowSkip="{{item.content.allowSkip}}"
                collectedInfo="{{item.content.collectedInfo}}"
                disabled="{{item.content.disabled}}"
                bind:select="onAskPreferenceSelect"
                bind:skip="onAskPreferenceSkip"
              />
            </block>
            
            <!-- Widget_Error -->
            <block wx:elif="{{item.type === 'widget_error'}}">
              <widget-error 
                message="{{item.content.message || '出了点问题'}}"
                showRetry="{{item.content.showRetry !== false}}"
                data-original-text="{{item.content.originalText}}"
                bind:retry="onWidgetErrorRetry"
              />
            </block>
          </block>
        </view>
      </block>
    </view>
    
    <!-- AI 思考态 -->
    <view wx:if="{{aiThinkingState === 'thinking'}}" class="message-item message-item--assistant slide-up-fade-in">
      <thinking-bubble text="{{thinkingText}}" />
    </view>
    
    <!-- Widget 骨架屏 -->
    <view wx:if="{{skeletonType}}" class="message-item message-item--assistant slide-up-fade-in">
      <widget-skeleton type="{{skeletonType}}" />
    </view>
    
    <!-- 底部占位（为 AI Dock 留空间） -->
    <view class="bottom-spacer"></view>
  </scroll-view>
  
  <!-- AI Dock (超级输入坞) -->
  <ai-dock 
    id="aiDock"
    placeholder="粘贴文字，或直接告诉我..."
    bind:send="onSend"
    bind:parse="onParse"
    bind:paste="onPaste"
  />
  
  <!-- 手机号绑定半屏 -->
  <auth-sheet 
    show="{{isAuthSheetVisible}}"
    bind:success="onAuthSuccess"
    bind:pendingaction="onPendingAction"
  />
  
  <!-- 分享引导蒙层 -->
  <share-guide 
    show="{{isShareGuideVisible}}"
    title="{{shareGuideData.title}}"
    mapUrl="{{shareGuideData.mapUrl}}"
  />
</view>
