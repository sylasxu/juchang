<!--
  æ´»åŠ¨ç¾¤èŠé¡µé¢ (Lite_Chat)
  Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8
-->
<view class="chat-page">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <custom-navbar 
    title="{{activity.title || 'ç¾¤èŠ'}}" 
    showBack="{{true}}"
    showMenu="{{false}}"
    showMore="{{false}}"
    bind:back="onBackTap"
  />

  <!-- æ´»åŠ¨ä¿¡æ¯å¤´éƒ¨ -->
  <view 
    class="activity-header" 
    bind:tap="onActivityTap" 
    wx:if="{{activity}}"
  >
    <view class="activity-info">
      <view class="activity-title">{{activity.title}}</view>
      <view class="activity-meta">
        <text class="meta-item">
          <text class="icon-location"></text>
          {{activity.locationName}}
        </text>
        <text class="meta-divider">Â·</text>
        <text class="meta-item">
          <text class="icon-users"></text>
          {{activity.currentParticipants}}/{{activity.maxParticipants}}äºº
        </text>
      </view>
    </view>
    <view class="activity-status {{isArchived ? 'archived' : 'active'}}">
      {{isArchived ? 'å·²å½’æ¡£' : 'è¿›è¡Œä¸­'}}
    </view>
    <view class="chevron-icon">
      <text class="icon-chevron-right"></text>
    </view>
  </view>

  <!-- å½’æ¡£æç¤ºæ¡ -->
  <view class="archive-banner" wx:if="{{isArchived}}">
    <text class="icon-info"></text>
    <text>ç¾¤èŠå·²å½’æ¡£ï¼Œæ— æ³•å‘é€æ–°æ¶ˆæ¯</text>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view
    class="message-list"
    scroll-y
    enhanced
    show-scrollbar="{{false}}"
    scroll-into-view="{{scrollToMessage}}"
    scroll-with-animation
    style="padding-bottom: {{keyboardHeight > 0 ? (keyboardHeight + 120) + 'px' : '140rpx'}}"
  >
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading}}">
      <t-loading theme="circular" size="48rpx" />
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <block wx:for="{{messages}}" wx:key="id">
      <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
      <view 
        wx:if="{{item.isSystem}}"
        id="msg-{{item.id}}"
        class="system-message"
      >
        <text class="system-text">{{item.content}}</text>
      </view>

      <!-- æ™®é€šæ¶ˆæ¯ -->
      <view
        wx:else
        id="msg-{{item.id}}"
        class="message-item {{item.isSelf ? 'self' : 'other'}}"
        data-id="{{item.id}}"
        data-is-self="{{item.isSelf}}"
        bindlongpress="onMessageLongPress"
      >
        <!-- å¤´åƒ -->
        <image
          class="avatar"
          src="{{item.senderAvatarUrl || '/static/images/default-avatar.png'}}"
          mode="aspectFill"
        />
        
        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message-content">
          <!-- å‘é€è€…æ˜µç§°ï¼ˆéè‡ªå·±çš„æ¶ˆæ¯æ˜¾ç¤ºï¼‰ -->
          <view class="sender-name" wx:if="{{!item.isSelf}}">
            {{item.senderNickname || 'ç”¨æˆ·'}}
          </view>
          
          <!-- æ¶ˆæ¯æ°”æ³¡ -->
          <view class="message-bubble {{item.isSelf ? 'self-bubble' : 'other-bubble'}}">
            <text class="message-text">{{item.content}}</text>
          </view>
          
          <!-- æ—¶é—´ -->
          <view class="message-time">{{item.formattedTime}}</view>
        </view>
      </view>
    </block>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && messages.length === 0}}">
      <view class="empty-icon">ğŸ’¬</view>
      <text class="empty-title">æš‚æ— æ¶ˆæ¯</text>
      <text class="empty-desc">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹èŠå¤©å§</text>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view 
    class="input-area {{isArchived ? 'disabled' : ''}}" 
    style="bottom: {{keyboardHeight > 0 ? keyboardHeight + 'px' : '0'}}"
  >
    <view class="input-container">
      <input
        class="message-input"
        type="text"
        placeholder="{{isArchived ? 'ç¾¤èŠå·²å½’æ¡£' : 'è¾“å…¥æ¶ˆæ¯...'}}"
        placeholder-class="input-placeholder"
        value="{{inputValue}}"
        disabled="{{isArchived}}"
        confirm-type="send"
        adjust-position="{{false}}"
        bindinput="onInputChange"
        bindconfirm="onSendMessage"
        bindkeyboardheightchange="onKeyboardHeightChange"
        bindblur="onInputBlur"
      />
      <view
        class="send-btn {{inputValue.trim() && !isArchived ? 'active' : ''}}"
        bind:tap="onSendMessage"
      >
        <text class="icon-send"></text>
      </view>
    </view>
    <view class="safe-area-bottom"></view>
  </view>
  
  <!-- ä¸¾æŠ¥å¼¹çª— -->
  <report-sheet
    visible="{{showReportSheet}}"
    type="message"
    targetId="{{reportMessageId}}"
    bind:close="onReportClose"
    bind:success="onReportSuccess"
  />
</view>
