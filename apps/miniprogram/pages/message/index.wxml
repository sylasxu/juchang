<!--
  消息中心页面
  Requirements: 9.1, 9.2, 9.3, 9.4, 9.5
  
  - 显示所有参与的活动群聊列表
  - 显示活动标题、最后一条消息、未读数量
  - 点击跳转到 Lite_Chat 页面
-->
<view class="message-page">
  <!-- 自定义导航栏 -->
  <custom-navbar 
    title="消息中心" 
    showMenu="{{false}}" 
    showMore="{{false}}"
    showBack="{{true}}"
    bindback="goBack"
  />

  <!-- 内容区域 -->
  <scroll-view
    class="message-scroll"
    scroll-y
    enhanced
    show-scrollbar="{{false}}"
    refresher-enabled
    refresher-triggered="{{loading}}"
    bindrefresherrefresh="loadData"
  >
    <!-- 系统通知区域 -->
    <view class="section-card">
      <view 
        class="section-header"
        bind:tap="toggleNotificationExpand"
      >
        <view class="section-title">
          <view class="section-icon section-icon--amber">
            <t-icon name="notification" size="36rpx" />
          </view>
          <text>系统通知</text>
          <t-badge
            wx:if="{{unreadNotificationCount > 0}}"
            count="{{unreadNotificationCount}}"
          />
        </view>
        <t-icon
          name="{{notificationExpanded ? 'chevron-up' : 'chevron-down'}}"
          size="40rpx"
          color="#9CA3AF"
        />
      </view>

      <view wx:if="{{notificationExpanded}}" class="notification-list">
        <block wx:if="{{notifications.length > 0}}">
          <view
            wx:for="{{notifications}}"
            wx:key="id"
            class="notification-item {{item.read ? '' : 'notification-item--unread'}}"
            data-id="{{item.id}}"
            data-type="{{item.type}}"
            data-activity-id="{{item.activityId}}"
            data-participant-id="{{item.participantId}}"
            bind:tap="onNotificationTap"
          >
            <!-- 图标 -->
            <view class="notification-icon notification-icon--{{item.type}}">
              <t-icon
                name="{{item.type === 'join_request' ? 'user-add' : item.type === 'no_show' ? 'error-circle' : 'notification'}}"
                size="40rpx"
              />
            </view>
            <!-- 内容 -->
            <view class="notification-content">
              <text class="notification-title">{{item.title}}</text>
              <text class="notification-desc">{{item.content}}</text>
              <text class="notification-time">{{item.createdAt}}</text>
            </view>
            <!-- 操作 -->
            <view
              wx:if="{{item.type === 'no_show' && item.canDispute}}"
              class="notification-action"
              data-activity-id="{{item.activityId}}"
              data-participant-id="{{item.participantId}}"
              catch:tap="onDisputeTap"
            >
              <t-button size="extra-small" theme="primary" variant="outline">
                我到场了
              </t-button>
            </view>
            <view wx:else class="notification-arrow">
              <t-icon name="chevron-right" size="36rpx" color="#9CA3AF" />
            </view>
          </view>
        </block>
        <view wx:else class="empty-state">
          <text>暂无系统通知</text>
        </view>
      </view>
    </view>

    <!-- 群聊列表区域 -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title">
          <view class="section-icon section-icon--blue">
            <t-icon name="chat" size="36rpx" />
          </view>
          <text>活动群聊</text>
        </view>
      </view>

      <view class="chat-list">
        <block wx:if="{{chatList.length > 0}}">
          <view
            wx:for="{{chatList}}"
            wx:key="activityId"
            class="chat-item {{item.isArchived ? 'chat-item--archived' : ''}}"
            data-activity-id="{{item.activityId}}"
            bind:tap="onChatTap"
          >
            <!-- 头像 -->
            <view class="chat-avatar">
              <image
                src="{{item.activityImage || '/static/images/default-activity.png'}}"
                mode="aspectFill"
                class="chat-avatar__img"
              />
              <view wx:if="{{item.isArchived}}" class="chat-avatar__badge">
                <text>已归档</text>
              </view>
            </view>
            <!-- 信息 -->
            <view class="chat-content">
              <view class="chat-header">
                <text class="chat-title">{{item.activityTitle}}</text>
                <text class="chat-time">{{item.lastMessageTime}}</text>
              </view>
              <view class="chat-footer">
                <text class="chat-message">{{item.lastMessage || '暂无消息'}}</text>
                <t-badge
                  wx:if="{{item.unreadCount > 0}}"
                  count="{{item.unreadCount}}"
                />
              </view>
              <view class="chat-meta">
                <t-icon name="user" size="24rpx" />
                <text>{{item.participantCount}}人</text>
              </view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-state empty-state--large">
          <t-icon name="chat" size="96rpx" color="#E5E7EB" />
          <text class="empty-title">暂无群聊</text>
          <text class="empty-desc">参与活动后即可加入群聊</text>
        </view>
      </view>
    </view>
  </scroll-view>
</view>
