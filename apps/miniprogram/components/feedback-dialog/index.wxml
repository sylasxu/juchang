<!--
  差评反馈弹窗组件
  Requirements: 13.1, 13.2, 13.3, 13.4
-->
<view class="feedback-dialog-mask" wx:if="{{visible}}" bind:tap="onClose">
  <view class="feedback-dialog" catch:tap="noop">
    <!-- 头部 -->
    <view class="flex items-center justify-between p-4 border-b">
      <text class="text-xl font-semibold text-gray-900">活动体验如何？</text>
      <view class="flex items-center justify-center text-gray-500" style="width: 64rpx; height: 64rpx;" bind:tap="onClose">
        <t-icon name="close" size="44rpx" />
      </view>
    </view>

    <!-- 步骤1：选择问题类型 -->
    <view class="flex-1 overflow-y-auto p-4" wx:if="{{step === 1}}">
      <view class="flex gap-3 mb-5">
        <view class="good-btn" bind:tap="onGoodFeedback">
          <t-icon name="thumb-up" size="48rpx" />
          <text>挺好的</text>
        </view>
        <view class="problem-btn" bind:tap="onNextStep" wx:if="{{selectedProblem}}">
          <t-icon name="thumb-down" size="48rpx" />
          <text>有问题</text>
        </view>
      </view>

      <view class="text-base font-medium text-gray-900 mb-3">遇到什么问题？</view>
      <view class="flex flex-wrap gap-3 mb-5">
        <view
          wx:for="{{problemOptions}}"
          wx:key="value"
          class="problem-option {{selectedProblem === item.value ? 'selected' : ''}}"
          data-value="{{item.value}}"
          bind:tap="onSelectProblem"
        >
          <t-icon name="{{item.icon}}" size="44rpx" />
          <text>{{item.label}}</text>
        </view>
      </view>

      <view class="pt-3 safe-bottom">
        <t-button theme="primary" size="large" block disabled="{{!selectedProblem}}" bind:tap="onNextStep">
          下一步：选择反馈对象
        </t-button>
      </view>
    </view>

    <!-- 步骤2：选择反馈对象 -->
    <view class="flex-1 overflow-y-auto p-4" wx:if="{{step === 2}}">
      <view class="flex items-center gap-1 text-base text-gray-500 mb-3" bind:tap="onPrevStep">
        <t-icon name="chevron-left" size="40rpx" />
        <text>返回</text>
      </view>

      <view class="text-base font-medium text-gray-900 mb-3">选择反馈对象</view>
      <view class="mb-4">
        <view
          wx:for="{{participants}}"
          wx:key="userId"
          class="target-item {{selectedTargets.includes(item.userId) ? 'selected' : ''}}"
          data-user-id="{{item.userId}}"
          bind:tap="onToggleTarget"
        >
          <image class="w-9 h-9 rounded-full flex-shrink-0 mr-3" src="{{item.avatarUrl || '/static/images/default-avatar.png'}}" mode="aspectFill" />
          <text class="flex-1 text-base text-gray-900">{{item.nickname}}</text>
          <t-checkbox checked="{{selectedTargets.includes(item.userId)}}" icon="circle" borderless />
        </view>
      </view>

      <view class="mb-4">
        <view class="text-base font-medium text-gray-900 mb-3">补充说明（选填）</view>
        <textarea
          class="w-full p-3 bg-gray-100 rounded-lg text-base text-gray-900"
          style="height: 160rpx;"
          placeholder="请描述具体情况..."
          value="{{description}}"
          maxlength="200"
          bindinput="onDescriptionInput"
        />
        <view class="text-right text-xs text-gray-400 mt-1">{{description.length}}/200</view>
      </view>

      <view class="pt-3 safe-bottom">
        <t-button theme="primary" size="large" block disabled="{{selectedTargets.length === 0}}" loading="{{submitting}}" bind:tap="onSubmit">
          提交反馈
        </t-button>
      </view>
    </view>
  </view>
</view>
