<!--
  Chat Stream 组件
  Requirements: 1.4, 3.1, 15.16
  
  Chat-First 架构的对话流容器
  - 无限滚动容器
  - 用户消息（右侧对齐）和 AI 消息（左侧对齐）
  - 新消息自动滚动到底部
-->
<scroll-view
  class="chat-stream"
  scroll-y
  scroll-with-animation
  scroll-into-view="{{scrollToView}}"
  upper-threshold="100"
  bindscroll="onScroll"
  bindscrolltoupper="onScrollToUpper"
  enhanced
  show-scrollbar="{{false}}"
>
  <!-- 加载更多指示器 -->
  <view wx:if="{{loading}}" class="loading-indicator">
    <view class="loading-dots">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
  </view>
  
  <!-- 消息列表 -->
  <view class="message-list">
    <view 
      wx:for="{{messages}}" 
      wx:key="id"
      id="msg-{{item.id}}"
      class="message-item message-item--{{item.role}} {{index >= messages.length - 3 ? 'slide-up-fade-in' : ''}}"
      style="animation-delay: {{(index - (messages.length - 3)) * 50}}ms;"
      data-id="{{item.id}}"
      data-index="{{index}}"
      bindtap="onMessageTap"
    >
      <!-- 用户消息 -->
      <block wx:if="{{item.role === 'user'}}">
        <message-bubble 
          role="user" 
          content="{{item.content}}"
        />
      </block>
      
      <!-- AI 消息 -->
      <block wx:else>
        <!-- 文本消息 -->
        <block wx:if="{{item.messageType === 'text'}}">
          <message-bubble 
            role="assistant" 
            content="{{item.content}}"
          />
        </block>
        
        <!-- Widget 消息 - 通过 slot 传入 -->
        <block wx:else>
          <view class="widget-container">
            <slot name="widget-{{item.id}}"></slot>
          </view>
        </block>
      </block>
    </view>
  </view>
  
  <!-- 底部占位（为 AI Dock 留空间） -->
  <view class="bottom-spacer"></view>
</scroll-view>
