<!--
  æ´»åŠ¨å¡ç‰‡ç»„ä»¶
  Requirements: 2.5, 2.6 - ç‚¹å‡»Pinæ˜¾ç¤ºæ´»åŠ¨ç®€è¦ä¿¡æ¯ï¼Œç‚¹å‡»å¡ç‰‡è·³è½¬è¯¦æƒ…é¡µ
-->
<wxs module="utils">
  // æ ¼å¼åŒ–æ—¶é—´
  function formatTime(dateStr) {
    if (!dateStr) return '';
    var date = getDate(dateStr);
    var now = getDate();
    
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var timeStr = (hours < 10 ? '0' + hours : hours) + ':' + (minutes < 10 ? '0' + minutes : minutes);
    
    // ç®€å•åˆ¤æ–­æ˜¯å¦ä»Šå¤©
    if (date.getFullYear() === now.getFullYear() && 
        date.getMonth() === now.getMonth() && 
        date.getDate() === now.getDate()) {
      return 'ä»Šå¤© ' + timeStr;
    }
    
    var month = date.getMonth() + 1;
    var day = date.getDate();
    return month + 'æœˆ' + day + 'æ—¥ ' + timeStr;
  }
  
  // è·å–è´¹ç”¨ç±»å‹æ–‡æœ¬
  function getFeeTypeText(feeType) {
    var map = {
      free: 'å…è´¹',
      aa: 'AAåˆ¶',
      fixed: 'å›ºå®šè´¹ç”¨',
      treat: 'è¯·å®¢'
    };
    return map[feeType] || feeType || '';
  }
  
  // è·å–æ´»åŠ¨ç±»å‹æ–‡æœ¬
  function getActivityTypeText(type) {
    var map = {
      food: 'ç¾é£Ÿ',
      entertainment: 'å¨±ä¹',
      sports: 'è¿åŠ¨',
      study: 'å­¦ä¹ ',
      travel: 'æ—…è¡Œ',
      other: 'å…¶ä»–'
    };
    return map[type] || type || '';
  }
  
  // è®¡ç®—é è°±åº¦
  function calculateReliability(creator) {
    if (!creator || !creator.participationCount || creator.participationCount === 0) {
      return -1;
    }
    return Math.round((creator.fulfillmentCount / creator.participationCount) * 100);
  }
  
  // è·å–é è°±åº¦æ ‡ç­¾
  function getReliabilityLabel(rate) {
    if (rate === -1) return 'ğŸ†• æ–°ç”¨æˆ·';
    if (rate === 100) return 'â­â­â­';
    if (rate >= 80) return 'â­â­';
    if (rate >= 60) return 'â­';
    return 'å¾…æå‡';
  }
  
  module.exports = {
    formatTime: formatTime,
    getFeeTypeText: getFeeTypeText,
    getActivityTypeText: getActivityTypeText,
    calculateReliability: calculateReliability,
    getReliabilityLabel: getReliabilityLabel
  };
</wxs>

<!-- å¼¹çª—æ¨¡å¼ -->
<view wx:if="{{mode === 'popup'}}" class="activity-card popup" bindtap="onCardTap">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="card-loading">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="card-error">
    <t-icon name="error-circle" size="48rpx" color="#ff4d4f" />
    <text class="error-text">åŠ è½½å¤±è´¥</text>
  </view>
  
  <!-- æ´»åŠ¨å†…å®¹ -->
  <view wx:else class="card-content">
    <!-- æ´»åŠ¨å›¾ç‰‡ -->
    <view wx:if="{{activityDetail.images && activityDetail.images.length > 0}}" class="card-image">
      <image src="{{activityDetail.images[0]}}" mode="aspectFill" />
    </view>
    <view wx:else class="card-image placeholder">
      <t-icon name="image" size="64rpx" color="#ccc" />
    </view>
    
    <!-- æ´»åŠ¨ä¿¡æ¯ -->
    <view class="card-info">
      <!-- æ ‡é¢˜å’Œæ ‡ç­¾ -->
      <view class="card-header">
        <text class="card-title">{{activityDetail.title || activity.title}}</text>
        <view class="card-tags">
          <t-tag wx:if="{{activityDetail.type}}" size="small" variant="light" theme="primary">
            {{utils.getActivityTypeText(activityDetail.type)}}
          </t-tag>
          <t-tag wx:if="{{activityDetail.isPinPlus}}" size="small" variant="light" theme="warning">
            Pin+
          </t-tag>
        </view>
      </view>
      
      <!-- æ—¶é—´ -->
      <view class="card-row">
        <t-icon name="time" size="28rpx" color="#666" />
        <text class="card-text">{{utils.formatTime(activityDetail.startAt)}}</text>
      </view>
      
      <!-- åœ°ç‚¹ -->
      <view class="card-row">
        <t-icon name="location" size="28rpx" color="#666" />
        <text class="card-text">{{activityDetail.locationName || activity.locationHint || 'ä½ç½®å¾…å®š'}}</text>
      </view>
      
      <!-- äººæ•°å’Œè´¹ç”¨ -->
      <view class="card-row">
        <t-icon name="user" size="28rpx" color="#666" />
        <text class="card-text">{{activityDetail.currentParticipants || 0}}/{{activityDetail.maxParticipants || '?'}}äºº</text>
        <view class="card-divider"></view>
        <text class="card-text fee-text">{{utils.getFeeTypeText(activityDetail.feeType)}}</text>
        <text wx:if="{{activityDetail.estimatedCost}}" class="card-text fee-amount">çº¦Â¥{{activityDetail.estimatedCost}}</text>
      </view>
      
      <!-- å‘èµ·äººä¿¡æ¯ -->
      <view wx:if="{{activityDetail.creator}}" class="card-creator" catchtap="onCreatorTap">
        <t-avatar 
          image="{{activityDetail.creator.avatarUrl}}" 
          size="48rpx"
          icon="user"
        />
        <text class="creator-name">{{activityDetail.creator.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
        <reliability-badge rate="{{utils.calculateReliability(activityDetail.creator)}}" show-label="{{true}}" />
      </view>
    </view>
    
    <!-- æŸ¥çœ‹è¯¦æƒ…æç¤º -->
    <view class="card-footer">
      <text class="footer-text">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</text>
      <t-icon name="chevron-right" size="28rpx" color="#999" />
    </view>
  </view>
</view>

<!-- åˆ—è¡¨æ¨¡å¼ -->
<view wx:else class="activity-card list" bindtap="onCardTap">
  <view class="list-content">
    <!-- å·¦ä¾§ä¿¡æ¯ -->
    <view class="list-info">
      <view class="list-header">
        <text class="list-title">{{activity.title}}</text>
        <t-tag wx:if="{{activity.isBoosted}}" size="small" variant="light" theme="danger">
          ğŸ”¥æ€¥æ‹›
        </t-tag>
        <t-tag wx:if="{{activity.isPinPlus}}" size="small" variant="light" theme="warning">
          Pin+
        </t-tag>
      </view>
      <view class="list-row">
        <t-icon name="location" size="24rpx" color="#999" />
        <text class="list-text">{{activity.locationHint || 'ä½ç½®å¾…å®š'}}</text>
      </view>
    </view>
    
    <!-- å³ä¾§ç®­å¤´ -->
    <view class="list-arrow">
      <t-icon name="chevron-right" size="32rpx" color="#ccc" />
    </view>
  </view>
</view>
