<!--
  æ´»åŠ¨å¡ç‰‡ç»„ä»¶
  Requirements: 2.5, 2.6 - ç‚¹å‡»Pinæ˜¾ç¤ºæ´»åŠ¨ç®€è¦ä¿¡æ¯ï¼Œç‚¹å‡»å¡ç‰‡è·³è½¬è¯¦æƒ…é¡µ
-->
<wxs module="utils">
  function formatTime(dateStr) {
    if (!dateStr) return '';
    var date = getDate(dateStr);
    var now = getDate();
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var timeStr = (hours < 10 ? '0' + hours : hours) + ':' + (minutes < 10 ? '0' + minutes : minutes);
    if (date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth() && date.getDate() === now.getDate()) {
      return 'ä»Šå¤© ' + timeStr;
    }
    var month = date.getMonth() + 1;
    var day = date.getDate();
    return month + 'æœˆ' + day + 'æ—¥ ' + timeStr;
  }
  function getFeeTypeText(feeType) {
    var map = { free: 'å…è´¹', aa: 'AAåˆ¶', fixed: 'å›ºå®šè´¹ç”¨', treat: 'è¯·å®¢' };
    return map[feeType] || feeType || '';
  }
  function getActivityTypeText(type) {
    var map = { food: 'ç¾é£Ÿ', entertainment: 'å¨±ä¹', sports: 'è¿åŠ¨', study: 'å­¦ä¹ ', travel: 'æ—…è¡Œ', other: 'å…¶ä»–' };
    return map[type] || type || '';
  }
  function calculateReliability(creator) {
    if (!creator || !creator.participationCount || creator.participationCount === 0) return -1;
    return Math.round((creator.fulfillmentCount / creator.participationCount) * 100);
  }
  module.exports = { formatTime: formatTime, getFeeTypeText: getFeeTypeText, getActivityTypeText: getActivityTypeText, calculateReliability: calculateReliability };
</wxs>

<!-- å¼¹çª—æ¨¡å¼ -->
<view wx:if="{{mode === 'popup'}}" class="bg-white rounded-lg overflow-hidden w-full" bindtap="onCardTap">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="flex flex-col items-center justify-center py-10">
    <t-loading theme="circular" size="48rpx" />
    <text class="mt-2 text-sm text-gray-400">åŠ è½½ä¸­...</text>
  </view>
  
  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="flex flex-col items-center justify-center py-10">
    <t-icon name="error-circle" size="48rpx" color="#ff4d4f" />
    <text class="mt-2 text-sm text-gray-400">åŠ è½½å¤±è´¥</text>
  </view>
  
  <!-- æ´»åŠ¨å†…å®¹ -->
  <view wx:else class="flex flex-col">
    <!-- æ´»åŠ¨å›¾ç‰‡ -->
    <view wx:if="{{activityDetail.images && activityDetail.images.length > 0}}" class="w-full bg-gray-100" style="height: 280rpx;">
      <image src="{{activityDetail.images[0]}}" mode="aspectFill" class="w-full h-full" />
    </view>
    <view wx:else class="w-full bg-gray-100 flex items-center justify-center" style="height: 280rpx;">
      <t-icon name="image" size="64rpx" color="#ccc" />
    </view>
    
    <!-- æ´»åŠ¨ä¿¡æ¯ -->
    <view class="p-3">
      <!-- æ ‡é¢˜å’Œæ ‡ç­¾ -->
      <view class="flex items-start justify-between mb-2">
        <text class="flex-1 text-lg font-semibold text-gray-900 line-clamp-2">{{activityDetail.title || activity.title}}</text>
        <view class="flex gap-1 ml-2 flex-shrink-0">
          <t-tag wx:if="{{activityDetail.type}}" size="small" variant="light" theme="primary">{{utils.getActivityTypeText(activityDetail.type)}}</t-tag>
          <t-tag wx:if="{{activityDetail.isPinPlus}}" size="small" variant="light" theme="warning">Pin+</t-tag>
        </view>
      </view>
      
      <!-- æ—¶é—´ -->
      <view class="flex items-center mb-2">
        <t-icon name="time" size="28rpx" color="#666" />
        <text class="ml-1 text-sm text-gray-600">{{utils.formatTime(activityDetail.startAt)}}</text>
      </view>
      
      <!-- åœ°ç‚¹ -->
      <view class="flex items-center mb-2">
        <t-icon name="location" size="28rpx" color="#666" />
        <text class="ml-1 text-sm text-gray-600">{{activityDetail.locationName || activity.locationHint || 'ä½ç½®å¾…å®š'}}</text>
      </view>
      
      <!-- äººæ•°å’Œè´¹ç”¨ -->
      <view class="flex items-center mb-2">
        <t-icon name="user" size="28rpx" color="#666" />
        <text class="ml-1 text-sm text-gray-600">{{activityDetail.currentParticipants || 0}}/{{activityDetail.maxParticipants || '?'}}äºº</text>
        <view class="w-px h-3 bg-gray-200 mx-2"></view>
        <text class="text-sm text-brand">{{utils.getFeeTypeText(activityDetail.feeType)}}</text>
        <text wx:if="{{activityDetail.estimatedCost}}" class="text-sm text-gray-400 ml-1">çº¦Â¥{{activityDetail.estimatedCost}}</text>
      </view>
      
      <!-- å‘èµ·äººä¿¡æ¯ -->
      <view wx:if="{{activityDetail.creator}}" class="flex items-center mt-3 pt-3 border-t" catchtap="onCreatorTap">
        <t-avatar image="{{activityDetail.creator.avatarUrl}}" size="48rpx" icon="user" />
        <text class="ml-2 text-sm text-gray-900">{{activityDetail.creator.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
        <view class="ml-auto">
          <reliability-badge rate="{{utils.calculateReliability(activityDetail.creator)}}" show-label="{{true}}" />
        </view>
      </view>
    </view>
    
    <!-- æŸ¥çœ‹è¯¦æƒ…æç¤º -->
    <view class="flex items-center justify-center py-3 bg-gray-50 border-t">
      <text class="text-sm text-gray-400 mr-1">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</text>
      <t-icon name="chevron-right" size="28rpx" color="#999" />
    </view>
  </view>
</view>

<!-- åˆ—è¡¨æ¨¡å¼ -->
<view wx:else class="bg-white rounded-lg shadow-sm mb-2 overflow-hidden" bindtap="onCardTap">
  <view class="flex items-center p-3">
    <view class="flex-1 min-w-0">
      <view class="flex items-center gap-1 mb-1">
        <text class="text-base font-medium text-gray-900 truncate" style="max-width: 400rpx;">{{activity.title}}</text>
        <t-tag wx:if="{{activity.isBoosted}}" size="small" variant="light" theme="danger">ğŸ”¥æ€¥æ‹›</t-tag>
        <t-tag wx:if="{{activity.isPinPlus}}" size="small" variant="light" theme="warning">Pin+</t-tag>
      </view>
      <view class="flex items-center">
        <t-icon name="location" size="24rpx" color="#999" />
        <text class="ml-1 text-xs text-gray-400 truncate">{{activity.locationHint || 'ä½ç½®å¾…å®š'}}</text>
      </view>
    </view>
    <view class="flex-shrink-0 ml-2">
      <t-icon name="chevron-right" size="32rpx" color="#ccc" />
    </view>
  </view>
</view>
