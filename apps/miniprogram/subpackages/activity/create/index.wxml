<!--
  åˆ›å»ºæ´»åŠ¨é¡µé¢
  Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6
-->
<wxs module="utils">
  // è·å–æ´»åŠ¨ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
  function getTypeLabel(value, types) {
    if (!value || !types) return 'è¯·é€‰æ‹©';
    for (var i = 0; i < types.length; i++) {
      if (types[i].value === value) return types[i].label;
    }
    return 'è¯·é€‰æ‹©';
  }
  
  // è·å–è´¹ç”¨ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
  function getFeeTypeLabel(value, types) {
    if (!value || !types) return 'AAåˆ¶';
    for (var i = 0; i < types.length; i++) {
      if (types[i].value === value) return types[i].label;
    }
    return 'AAåˆ¶';
  }
  
  // è·å–åŠ å…¥æ¨¡å¼æ˜¾ç¤ºæ–‡æœ¬
  function getJoinModeLabel(value, modes) {
    if (!value || !modes) return 'éœ€è¦å®¡æ‰¹';
    for (var i = 0; i < modes.length; i++) {
      if (modes[i].value === value) return modes[i].label;
    }
    return 'éœ€è¦å®¡æ‰¹';
  }
  
  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  function formatDateTime(dateStr) {
    if (!dateStr) return 'è¯·é€‰æ‹©';
    var date = getDate(dateStr);
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var hoursStr = hours < 10 ? '0' + hours : '' + hours;
    var minutesStr = minutes < 10 ? '0' + minutes : '' + minutes;
    return month + 'æœˆ' + day + 'æ—¥ ' + hoursStr + ':' + minutesStr;
  }
  
  module.exports = {
    getTypeLabel: getTypeLabel,
    getFeeTypeLabel: getFeeTypeLabel,
    getJoinModeLabel: getJoinModeLabel,
    formatDateTime: formatDateTime
  };
</wxs>

<view class="create-activity">
  <scroll-view scroll-y class="form-scroll">
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      
      <!-- æ´»åŠ¨æ ‡é¢˜ -->
      <view class="form-item">
        <view class="form-label required">æ´»åŠ¨æ ‡é¢˜</view>
        <t-input
          placeholder="è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜ï¼ˆæœ€å¤š100å­—ï¼‰"
          value="{{form.title}}"
          maxlength="{{100}}"
          bindinput="onTitleInput"
        />
      </view>
      
      <!-- æ´»åŠ¨ç±»å‹ -->
      <view class="form-item" bindtap="showTypePicker">
        <view class="form-label required">æ´»åŠ¨ç±»å‹</view>
        <view class="form-value">
          <text class="{{form.type ? '' : 'placeholder'}}">
            {{utils.getTypeLabel(form.type, activityTypes)}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#ccc" />
        </view>
      </view>
      
      <!-- æ´»åŠ¨æè¿° -->
      <view class="form-item">
        <view class="form-label">æ´»åŠ¨æè¿°</view>
        <t-textarea
          placeholder="ä»‹ç»ä¸€ä¸‹ä½ çš„æ´»åŠ¨å§~"
          value="{{form.description}}"
          maxlength="{{500}}"
          autosize
          bindinput="onDescriptionInput"
        />
      </view>
      
      <!-- æ´»åŠ¨å›¾ç‰‡ -->
      <view class="form-item">
        <view class="form-label">æ´»åŠ¨å›¾ç‰‡</view>
        <t-upload
          media-type="{{['image']}}"
          max="{{maxImageCount}}"
          files="{{form.images}}"
          bind:success="onImageSuccess"
          bind:remove="onImageRemove"
        />
      </view>
    </view>
    
    <!-- æ—¶é—´åœ°ç‚¹ -->
    <view class="section">
      <view class="section-title">æ—¶é—´åœ°ç‚¹</view>
      
      <!-- å¼€å§‹æ—¶é—´ -->
      <view class="form-item" bindtap="showStartTimePicker">
        <view class="form-label required">å¼€å§‹æ—¶é—´</view>
        <view class="form-value">
          <text class="{{form.startAt ? '' : 'placeholder'}}">
            {{utils.formatDateTime(form.startAt)}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#ccc" />
        </view>
      </view>
      
      <!-- ç»“æŸæ—¶é—´ -->
      <view class="form-item" bindtap="showEndTimePicker">
        <view class="form-label">ç»“æŸæ—¶é—´</view>
        <view class="form-value">
          <text class="{{form.endAt ? '' : 'placeholder'}}">
            {{utils.formatDateTime(form.endAt)}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#ccc" />
        </view>
      </view>
      
      <!-- æ´»åŠ¨åœ°ç‚¹ -->
      <view class="form-item" bindtap="onChooseLocation">
        <view class="form-label required">æ´»åŠ¨åœ°ç‚¹</view>
        <view class="form-value">
          <text class="{{form.locationName ? '' : 'placeholder'}}">
            {{form.locationName || 'è¯·é€‰æ‹©åœ°ç‚¹'}}
          </text>
          <t-icon name="location" size="40rpx" color="#FF6B35" />
        </view>
      </view>
      
      <!-- è¯¦ç»†åœ°å€æ˜¾ç¤º -->
      <view wx:if="{{form.address}}" class="address-detail">
        <t-icon name="location" size="32rpx" color="#999" />
        <text>{{form.address}}</text>
      </view>
      
      <!-- ä½ç½®å¤‡æ³¨ (Requirements: 7.2) -->
      <view wx:if="{{form.latitude}}" class="form-item">
        <view class="form-label required">ä½ç½®å¤‡æ³¨</view>
        <t-input
          placeholder="å¦‚ï¼š4æ¥¼å¹³å°å…¥å£ã€æ˜Ÿå·´å…‹é—¨å£"
          value="{{form.locationHint}}"
          maxlength="{{50}}"
          bindinput="onLocationHintInput"
        />
        <view class="form-hint">å¸®åŠ©å‚ä¸è€…æ›´å®¹æ˜“æ‰¾åˆ°ä½ </view>
      </view>
      
      <!-- æ¨¡ç³Šä½ç½®å¼€å…³ (Requirements: 7.3) -->
      <view wx:if="{{form.latitude}}" class="form-item switch-item">
        <view class="switch-content">
          <view class="form-label">æ¨¡ç³Šåœ°ç†ä½ç½®</view>
          <view class="form-hint">å¼€å¯åï¼Œæœªé€šè¿‡å®¡æ‰¹çš„ç”¨æˆ·åªèƒ½çœ‹åˆ°å¤§è‡´ä½ç½®</view>
        </view>
        <t-switch value="{{form.isLocationBlurred}}" bind:change="onLocationBlurredChange" />
      </view>
    </view>
    
    <!-- æ´»åŠ¨è®¾ç½® -->
    <view class="section">
      <view class="section-title">æ´»åŠ¨è®¾ç½®</view>
      
      <!-- å‚ä¸äººæ•° -->
      <view class="form-item stepper-item">
        <view class="form-label required">å‚ä¸äººæ•°</view>
        <t-stepper
          value="{{form.maxParticipants}}"
          min="{{2}}"
          max="{{100}}"
          theme="filled"
          bind:change="onParticipantsChange"
        />
      </view>
      
      <!-- è´¹ç”¨ç±»å‹ -->
      <view class="form-item" bindtap="showFeeTypePicker">
        <view class="form-label">è´¹ç”¨ç±»å‹</view>
        <view class="form-value">
          <text>{{utils.getFeeTypeLabel(form.feeType, feeTypes)}}</text>
          <t-icon name="chevron-right" size="40rpx" color="#ccc" />
        </view>
      </view>
      
      <!-- é¢„ä¼°è´¹ç”¨ -->
      <view wx:if="{{form.feeType !== 'free'}}" class="form-item">
        <view class="form-label">é¢„ä¼°è´¹ç”¨</view>
        <t-input
          placeholder="è¯·è¾“å…¥é¢„ä¼°è´¹ç”¨ï¼ˆå…ƒï¼‰"
          value="{{form.estimatedCost}}"
          type="digit"
          bindinput="onEstimatedCostInput"
        />
      </view>
      
      <!-- åŠ å…¥æ¨¡å¼ -->
      <view class="form-item" bindtap="showJoinModePicker">
        <view class="form-label">åŠ å…¥æ–¹å¼</view>
        <view class="form-value">
          <text>{{utils.getJoinModeLabel(form.joinMode, joinModes)}}</text>
          <t-icon name="chevron-right" size="40rpx" color="#ccc" />
        </view>
      </view>
      
      <!-- é è°±åº¦é—¨æ§› -->
      <view class="form-item">
        <view class="form-label">é è°±åº¦é—¨æ§›</view>
        <t-input
          placeholder="ä¸é™åˆ¶è¯·ç•™ç©ºï¼ˆ0-100ï¼‰"
          value="{{form.minReliabilityRate}}"
          type="number"
          bindinput="onMinReliabilityInput"
        />
        <view class="form-hint">è®¾ç½®åï¼Œé è°±åº¦ä½äºæ­¤å€¼çš„ç”¨æˆ·æ— æ³•æŠ¥å</view>
      </view>
    </view>
    
    <!-- å¢å€¼æœåŠ¡ (Requirements: 7.6) -->
    <view class="section premium-section">
      <view class="section-title">
        <text>æ¨å¹¿æœåŠ¡</text>
        <t-tag size="small" variant="light" theme="warning">å¯é€‰</t-tag>
      </view>
      
      <!-- BoostæœåŠ¡ -->
      <view class="premium-item">
        <view class="premium-header">
          <t-checkbox value="{{enableBoost}}" bind:change="onBoostChange" />
          <view class="premium-info">
            <view class="premium-title">
              <text class="premium-name">ğŸ”¥ Boost å¼ºåŠ›å¬å”¤</text>
              <text class="premium-price">Â¥{{boostPrice}}</text>
            </view>
            <text class="premium-desc">å‘å‘¨å›´3kmå†…ç”¨æˆ·å‘é€æ¨é€é€šçŸ¥ï¼Œå¿«é€Ÿæ‹›äºº</text>
          </view>
        </view>
      </view>
      
      <!-- Pin+æœåŠ¡ -->
      <view class="premium-item">
        <view class="premium-header">
          <t-checkbox value="{{enablePinPlus}}" bind:change="onPinPlusChange" />
          <view class="premium-info">
            <view class="premium-title">
              <text class="premium-name">â­ Pin+ é»„é‡‘ç½®é¡¶</text>
              <text class="premium-price">Â¥{{pinPlusPrice}}</text>
            </view>
            <text class="premium-desc">åœ°å›¾Pinå˜å¤§å˜é‡‘è‰²ï¼ŒæŒç»­24å°æ—¶ï¼Œæ›´æ˜¾çœ¼</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>
  
  <!-- åº•éƒ¨æäº¤æ  -->
  <view class="bottom-bar">
    <view wx:if="{{enableBoost || enablePinPlus}}" class="price-info">
      <text class="price-label">å¢å€¼æœåŠ¡ï¼š</text>
      <text class="price-value">Â¥{{(enableBoost ? boostPrice : 0) + (enablePinPlus ? pinPlusPrice : 0)}}</text>
    </view>
    <t-button
      theme="primary"
      size="large"
      block
      loading="{{isSubmitting}}"
      disabled="{{isSubmitting}}"
      bindtap="onSubmit"
    >
      {{isSubmitting ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒæ´»åŠ¨'}}
    </t-button>
  </view>
  
  <!-- æ´»åŠ¨ç±»å‹é€‰æ‹©å™¨ -->
  <t-picker
    visible="{{showTypePicker}}"
    value="{{[form.type]}}"
    title="é€‰æ‹©æ´»åŠ¨ç±»å‹"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    bind:change="onTypeChange"
    bind:cancel="onTypePickerCancel"
  >
    <t-picker-item options="{{activityTypes}}" />
  </t-picker>
  
  <!-- è´¹ç”¨ç±»å‹é€‰æ‹©å™¨ -->
  <t-picker
    visible="{{showFeeTypePicker}}"
    value="{{[form.feeType]}}"
    title="é€‰æ‹©è´¹ç”¨ç±»å‹"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    bind:change="onFeeTypeChange"
    bind:cancel="onFeeTypePickerCancel"
  >
    <t-picker-item options="{{feeTypes}}" />
  </t-picker>
  
  <!-- åŠ å…¥æ¨¡å¼é€‰æ‹©å™¨ -->
  <t-picker
    visible="{{showJoinModePicker}}"
    value="{{[form.joinMode]}}"
    title="é€‰æ‹©åŠ å…¥æ–¹å¼"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    bind:change="onJoinModeChange"
    bind:cancel="onJoinModePickerCancel"
  >
    <t-picker-item options="{{joinModes}}" />
  </t-picker>
  
  <!-- å¼€å§‹æ—¶é—´é€‰æ‹©å™¨ -->
  <t-date-time-picker
    visible="{{showStartTimePicker}}"
    mode="minute"
    value="{{form.startAt}}"
    title="é€‰æ‹©å¼€å§‹æ—¶é—´"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    start="{{Date.now()}}"
    bind:change="onStartTimeChange"
    bind:cancel="onStartTimePickerCancel"
  />
  
  <!-- ç»“æŸæ—¶é—´é€‰æ‹©å™¨ -->
  <t-date-time-picker
    visible="{{showEndTimePicker}}"
    mode="minute"
    value="{{form.endAt || form.startAt}}"
    title="é€‰æ‹©ç»“æŸæ—¶é—´"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    start="{{form.startAt || Date.now()}}"
    bind:change="onEndTimeChange"
    bind:cancel="onEndTimePickerCancel"
  />
</view>
