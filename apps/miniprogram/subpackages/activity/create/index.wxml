<!--
  åˆ›å»ºæ´»åŠ¨é¡µé¢
  TDesign + Atomic Less é‡æ„
-->
<wxs module="utils">
  function getTypeLabel(value, types) {
    if (!value || !types) return 'è¯·é€‰æ‹©';
    for (var i = 0; i < types.length; i++) {
      if (types[i].value === value) return types[i].label;
    }
    return 'è¯·é€‰æ‹©';
  }
  
  function getFeeTypeLabel(value, types) {
    if (!value || !types) return 'AAåˆ¶';
    for (var i = 0; i < types.length; i++) {
      if (types[i].value === value) return types[i].label;
    }
    return 'AAåˆ¶';
  }
  
  function getJoinModeLabel(value, modes) {
    if (!value || !modes) return 'éœ€è¦å®¡æ‰¹';
    for (var i = 0; i < modes.length; i++) {
      if (modes[i].value === value) return modes[i].label;
    }
    return 'éœ€è¦å®¡æ‰¹';
  }
  
  function formatDateTime(dateStr) {
    if (!dateStr) return 'è¯·é€‰æ‹©';
    var date = getDate(dateStr);
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var hoursStr = hours < 10 ? '0' + hours : '' + hours;
    var minutesStr = minutes < 10 ? '0' + minutes : '' + minutes;
    return month + 'æœˆ' + day + 'æ—¥ ' + hoursStr + ':' + minutesStr;
  }
  
  module.exports = {
    getTypeLabel: getTypeLabel,
    getFeeTypeLabel: getFeeTypeLabel,
    getJoinModeLabel: getJoinModeLabel,
    formatDateTime: formatDateTime
  };
</wxs>

<view class="min-h-screen bg-gray-50 flex flex-col">
  <scroll-view scroll-y class="form-scroll flex-1">
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="bg-white mb-3 p-4">
      <view class="flex items-center gap-2 text-lg font-semibold text-gray-900 mb-3 pb-2 border-b border-gray-100">
        åŸºæœ¬ä¿¡æ¯
      </view>
      
      <!-- æ´»åŠ¨æ ‡é¢˜ -->
      <view class="mb-3">
        <view class="block text-sm font-medium text-gray-900 mb-2 required">æ´»åŠ¨æ ‡é¢˜</view>
        <t-input
          placeholder="è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜ï¼ˆæœ€å¤š100å­—ï¼‰"
          value="{{form.title}}"
          maxlength="{{100}}"
          bindinput="onTitleInput"
        />
      </view>
      
      <!-- æ´»åŠ¨ç±»å‹ -->
      <view class="mb-3" bindtap="showTypePicker">
        <view class="block text-sm font-medium text-gray-900 mb-2 required">æ´»åŠ¨ç±»å‹</view>
        <view class="flex items-center justify-between p-3 bg-gray-100 rounded-md text-sm">
          <text class="{{form.type ? 'text-gray-900' : 'placeholder'}}">
            {{utils.getTypeLabel(form.type, activityTypes)}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#D1D5DB" />
        </view>
      </view>
      
      <!-- æ´»åŠ¨æè¿° -->
      <view class="mb-3">
        <view class="block text-sm font-medium text-gray-900 mb-2">æ´»åŠ¨æè¿°</view>
        <t-textarea
          placeholder="ä»‹ç»ä¸€ä¸‹ä½ çš„æ´»åŠ¨å§~"
          value="{{form.description}}"
          maxlength="{{500}}"
          autosize
          bindinput="onDescriptionInput"
        />
      </view>
      
      <!-- æ´»åŠ¨å›¾ç‰‡ -->
      <view>
        <view class="block text-sm font-medium text-gray-900 mb-2">æ´»åŠ¨å›¾ç‰‡</view>
        <t-upload
          media-type="{{['image']}}"
          max="{{maxImageCount}}"
          files="{{form.images}}"
          bind:success="onImageSuccess"
          bind:remove="onImageRemove"
        />
      </view>
    </view>
    
    <!-- æ—¶é—´åœ°ç‚¹ -->
    <view class="bg-white mb-3 p-4">
      <view class="flex items-center gap-2 text-lg font-semibold text-gray-900 mb-3 pb-2 border-b border-gray-100">
        æ—¶é—´åœ°ç‚¹
      </view>
      
      <!-- å¼€å§‹æ—¶é—´ -->
      <view class="mb-3" bindtap="showStartTimePicker">
        <view class="block text-sm font-medium text-gray-900 mb-2 required">å¼€å§‹æ—¶é—´</view>
        <view class="flex items-center justify-between p-3 bg-gray-100 rounded-md text-sm">
          <text class="{{form.startAt ? 'text-gray-900' : 'placeholder'}}">
            {{utils.formatDateTime(form.startAt)}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#D1D5DB" />
        </view>
      </view>
      
      <!-- ç»“æŸæ—¶é—´ -->
      <view class="mb-3" bindtap="showEndTimePicker">
        <view class="block text-sm font-medium text-gray-900 mb-2">ç»“æŸæ—¶é—´</view>
        <view class="flex items-center justify-between p-3 bg-gray-100 rounded-md text-sm">
          <text class="{{form.endAt ? 'text-gray-900' : 'placeholder'}}">
            {{utils.formatDateTime(form.endAt)}}
          </text>
          <t-icon name="chevron-right" size="40rpx" color="#D1D5DB" />
        </view>
      </view>
      
      <!-- æ´»åŠ¨åœ°ç‚¹ -->
      <view class="mb-3" bindtap="onChooseLocation">
        <view class="block text-sm font-medium text-gray-900 mb-2 required">æ´»åŠ¨åœ°ç‚¹</view>
        <view class="flex items-center justify-between p-3 bg-gray-100 rounded-md text-sm">
          <text class="{{form.locationName ? 'text-gray-900' : 'placeholder'}}">
            {{form.locationName || 'è¯·é€‰æ‹©åœ°ç‚¹'}}
          </text>
          <t-icon name="location" size="40rpx" color="#FF6B35" />
        </view>
      </view>
      
      <!-- è¯¦ç»†åœ°å€æ˜¾ç¤º -->
      <view wx:if="{{form.address}}" class="flex items-start gap-1 px-3 py-2 bg-gray-100 rounded-sm -mt-2 mb-3">
        <t-icon name="location" size="32rpx" color="#9CA3AF" />
        <text class="flex-1 text-xs text-gray-600 leading-normal">{{form.address}}</text>
      </view>
      
      <!-- ä½ç½®å¤‡æ³¨ -->
      <view wx:if="{{form.latitude}}" class="mb-3">
        <view class="block text-sm font-medium text-gray-900 mb-2 required">ä½ç½®å¤‡æ³¨</view>
        <t-input
          placeholder="å¦‚ï¼š4æ¥¼å¹³å°å…¥å£ã€æ˜Ÿå·´å…‹é—¨å£"
          value="{{form.locationHint}}"
          maxlength="{{50}}"
          bindinput="onLocationHintInput"
        />
        <view class="text-xs text-gray-400 mt-1">å¸®åŠ©å‚ä¸è€…æ›´å®¹æ˜“æ‰¾åˆ°ä½ </view>
      </view>
      
      <!-- æ¨¡ç³Šä½ç½®å¼€å…³ -->
      <view wx:if="{{form.latitude}}" class="flex items-center justify-between pt-3 mt-2 border-t border-gray-100">
        <view class="flex-1 mr-3">
          <view class="text-sm font-medium text-gray-900 mb-1">æ¨¡ç³Šåœ°ç†ä½ç½®</view>
          <view class="text-xs text-gray-400">å¼€å¯åï¼Œæœªé€šè¿‡å®¡æ‰¹çš„ç”¨æˆ·åªèƒ½çœ‹åˆ°å¤§è‡´ä½ç½®</view>
        </view>
        <t-switch value="{{form.isLocationBlurred}}" bind:change="onLocationBlurredChange" />
      </view>
    </view>
    
    <!-- æ´»åŠ¨è®¾ç½® -->
    <view class="bg-white mb-3 p-4">
      <view class="flex items-center gap-2 text-lg font-semibold text-gray-900 mb-3 pb-2 border-b border-gray-100">
        æ´»åŠ¨è®¾ç½®
      </view>
      
      <!-- å‚ä¸äººæ•° -->
      <view class="flex items-center justify-between mb-3">
        <view class="text-sm font-medium text-gray-900 required">å‚ä¸äººæ•°</view>
        <t-stepper
          value="{{form.maxParticipants}}"
          min="{{2}}"
          max="{{100}}"
          theme="filled"
          bind:change="onParticipantsChange"
        />
      </view>
      
      <!-- è´¹ç”¨ç±»å‹ -->
      <view class="mb-3" bindtap="showFeeTypePicker">
        <view class="block text-sm font-medium text-gray-900 mb-2">è´¹ç”¨ç±»å‹</view>
        <view class="flex items-center justify-between p-3 bg-gray-100 rounded-md text-sm text-gray-900">
          <text>{{utils.getFeeTypeLabel(form.feeType, feeTypes)}}</text>
          <t-icon name="chevron-right" size="40rpx" color="#D1D5DB" />
        </view>
      </view>
      
      <!-- é¢„ä¼°è´¹ç”¨ -->
      <view wx:if="{{form.feeType !== 'free'}}" class="mb-3">
        <view class="block text-sm font-medium text-gray-900 mb-2">é¢„ä¼°è´¹ç”¨</view>
        <t-input
          placeholder="è¯·è¾“å…¥é¢„ä¼°è´¹ç”¨ï¼ˆå…ƒï¼‰"
          value="{{form.estimatedCost}}"
          type="digit"
          bindinput="onEstimatedCostInput"
        />
      </view>
      
      <!-- åŠ å…¥æ¨¡å¼ -->
      <view class="mb-3" bindtap="showJoinModePicker">
        <view class="block text-sm font-medium text-gray-900 mb-2">åŠ å…¥æ–¹å¼</view>
        <view class="flex items-center justify-between p-3 bg-gray-100 rounded-md text-sm text-gray-900">
          <text>{{utils.getJoinModeLabel(form.joinMode, joinModes)}}</text>
          <t-icon name="chevron-right" size="40rpx" color="#D1D5DB" />
        </view>
      </view>
      
      <!-- é è°±åº¦é—¨æ§› -->
      <view>
        <view class="block text-sm font-medium text-gray-900 mb-2">é è°±åº¦é—¨æ§›</view>
        <t-input
          placeholder="ä¸é™åˆ¶è¯·ç•™ç©ºï¼ˆ0-100ï¼‰"
          value="{{form.minReliabilityRate}}"
          type="number"
          bindinput="onMinReliabilityInput"
        />
        <view class="text-xs text-gray-400 mt-1">è®¾ç½®åï¼Œé è°±åº¦ä½äºæ­¤å€¼çš„ç”¨æˆ·æ— æ³•æŠ¥å</view>
      </view>
    </view>
    
    <!-- å¢å€¼æœåŠ¡ -->
    <view class="bg-white mb-3 p-4">
      <view class="flex items-center justify-between text-lg font-semibold text-gray-900 mb-3 pb-2 border-b border-gray-100">
        <text>æ¨å¹¿æœåŠ¡</text>
        <t-tag size="small" variant="light" theme="warning">å¯é€‰</t-tag>
      </view>
      
      <!-- BoostæœåŠ¡ -->
      <view class="premium-item p-3 rounded-md mb-2">
        <view class="flex items-start">
          <t-checkbox value="{{enableBoost}}" bind:change="onBoostChange" />
          <view class="flex-1 ml-2">
            <view class="flex items-center justify-between mb-1">
              <text class="text-base font-medium text-gray-900">ğŸ”¥ Boost å¼ºåŠ›å¬å”¤</text>
              <text class="text-lg font-semibold text-brand">Â¥{{boostPrice}}</text>
            </view>
            <text class="text-xs text-gray-400 leading-normal">å‘å‘¨å›´3kmå†…ç”¨æˆ·å‘é€æ¨é€é€šçŸ¥ï¼Œå¿«é€Ÿæ‹›äºº</text>
          </view>
        </view>
      </view>
      
      <!-- Pin+æœåŠ¡ -->
      <view class="premium-item p-3 rounded-md">
        <view class="flex items-start">
          <t-checkbox value="{{enablePinPlus}}" bind:change="onPinPlusChange" />
          <view class="flex-1 ml-2">
            <view class="flex items-center justify-between mb-1">
              <text class="text-base font-medium text-gray-900">â­ Pin+ é»„é‡‘ç½®é¡¶</text>
              <text class="text-lg font-semibold text-brand">Â¥{{pinPlusPrice}}</text>
            </view>
            <text class="text-xs text-gray-400 leading-normal">åœ°å›¾Pinå˜å¤§å˜é‡‘è‰²ï¼ŒæŒç»­24å°æ—¶ï¼Œæ›´æ˜¾çœ¼</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>
  
  <!-- åº•éƒ¨æäº¤æ  -->
  <view class="bottom-bar px-4 py-3">
    <view wx:if="{{enableBoost || enablePinPlus}}" class="flex items-center justify-end mb-2">
      <text class="text-sm text-gray-600">å¢å€¼æœåŠ¡ï¼š</text>
      <text class="text-lg font-semibold text-brand ml-1">Â¥{{(enableBoost ? boostPrice : 0) + (enablePinPlus ? pinPlusPrice : 0)}}</text>
    </view>
    <t-button
      theme="primary"
      size="large"
      block
      loading="{{isSubmitting}}"
      disabled="{{isSubmitting}}"
      bindtap="onSubmit"
    >
      {{isSubmitting ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒæ´»åŠ¨'}}
    </t-button>
  </view>
  
  <!-- é€‰æ‹©å™¨ç»„ä»¶ -->
  <t-picker
    visible="{{showTypePicker}}"
    value="{{[form.type]}}"
    title="é€‰æ‹©æ´»åŠ¨ç±»å‹"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    bind:change="onTypeChange"
    bind:cancel="onTypePickerCancel"
  >
    <t-picker-item options="{{activityTypes}}" />
  </t-picker>
  
  <t-picker
    visible="{{showFeeTypePicker}}"
    value="{{[form.feeType]}}"
    title="é€‰æ‹©è´¹ç”¨ç±»å‹"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    bind:change="onFeeTypeChange"
    bind:cancel="onFeeTypePickerCancel"
  >
    <t-picker-item options="{{feeTypes}}" />
  </t-picker>
  
  <t-picker
    visible="{{showJoinModePicker}}"
    value="{{[form.joinMode]}}"
    title="é€‰æ‹©åŠ å…¥æ–¹å¼"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    bind:change="onJoinModeChange"
    bind:cancel="onJoinModePickerCancel"
  >
    <t-picker-item options="{{joinModes}}" />
  </t-picker>
  
  <t-date-time-picker
    visible="{{showStartTimePicker}}"
    mode="minute"
    value="{{form.startAt}}"
    title="é€‰æ‹©å¼€å§‹æ—¶é—´"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    start="{{Date.now()}}"
    bind:change="onStartTimeChange"
    bind:cancel="onStartTimePickerCancel"
  />
  
  <t-date-time-picker
    visible="{{showEndTimePicker}}"
    mode="minute"
    value="{{form.endAt || form.startAt}}"
    title="é€‰æ‹©ç»“æŸæ—¶é—´"
    cancelBtn="å–æ¶ˆ"
    confirmBtn="ç¡®å®š"
    start="{{form.startAt || Date.now()}}"
    bind:change="onEndTimeChange"
    bind:cancel="onEndTimePickerCancel"
  />
</view>
