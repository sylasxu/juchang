<!--
  草稿编辑页面
  Requirements: 6.8, 15.4, CP-19
-->
<wxs module="utils">
  function getTypeLabel(type) {
    var map = {
      food: '美食', entertainment: '娱乐', sports: '运动',
      boardgame: '桌游', mahjong: '麻将', hotpot: '火锅',
      ktv: 'KTV', movie: '电影', game: '游戏',
      drink: '喝酒', coffee: '咖啡', hiking: '徒步', other: '其他'
    };
    return map[type] || '其他';
  }
  module.exports = { getTypeLabel: getTypeLabel };
</wxs>

<view class="min-h-screen bg-gray-50">
  <!-- 自定义导航栏 -->
  <custom-navbar 
    title="确认发布" 
    showMenu="{{false}}" 
    showMore="{{false}}"
    showBack="{{true}}"
  />

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="flex flex-col items-center justify-center py-12">
    <t-loading theme="circular" size="80rpx" />
    <text class="mt-3 text-sm text-gray-400">加载中...</text>
  </view>

  <!-- 编辑表单 -->
  <view wx:else class="p-4">
    <!-- 活动类型标签 -->
    <view class="flex items-center gap-2 mb-4">
      <view class="type-tag px-3 py-1 rounded-full text-sm text-white bg-brand">
        {{utils.getTypeLabel(draft.type)}}
      </view>
      <text class="text-xs text-gray-400">活动类型</text>
    </view>

    <!-- 标题编辑 -->
    <view class="form-card bg-white rounded-lg p-4 mb-3">
      <view class="flex items-center gap-2 mb-2">
        <t-icon name="edit" size="36rpx" color="#FF6B35" />
        <text class="text-sm font-medium text-gray-900">活动标题</text>
      </view>
      <t-input
        placeholder="请输入活动标题"
        value="{{draft.title}}"
        maxlength="{{50}}"
        bindinput="onTitleInput"
      />
    </view>

    <!-- 时间编辑 -->
    <view class="form-card bg-white rounded-lg p-4 mb-3" bindtap="showTimePicker">
      <view class="flex items-center gap-2 mb-2">
        <t-icon name="time" size="36rpx" color="#FF6B35" />
        <text class="text-sm font-medium text-gray-900">活动时间</text>
        <view wx:if="{{isExpired}}" class="expired-tag px-2 py-1 rounded-sm text-xs text-white bg-error">
          已过期
        </view>
      </view>
      <view class="flex items-center justify-between">
        <text class="text-base {{isExpired ? 'text-error' : 'text-gray-900'}}">{{formattedTime}}</text>
        <t-icon name="chevron-right" size="40rpx" color="#D1D5DB" />
      </view>
    </view>

    <!-- 地点信息 -->
    <view class="form-card bg-white rounded-lg p-4 mb-3">
      <view class="flex items-center gap-2 mb-2">
        <t-icon name="location" size="36rpx" color="#FF6B35" />
        <text class="text-sm font-medium text-gray-900">活动地点</text>
      </view>
      <view class="flex items-center justify-between mb-3" bindtap="onAdjustLocation">
        <text class="text-base text-gray-900 flex-1 truncate">{{draft.locationName || '请选择地点'}}</text>
        <view class="adjust-btn flex items-center gap-1 px-3 py-1 rounded-full text-xs text-brand">
          <t-icon name="location" size="28rpx" />
          <text>调整位置</text>
        </view>
      </view>
      <view wx:if="{{draft.address}}" class="text-xs text-gray-400 mb-3">{{draft.address}}</view>
      
      <!-- 位置备注 -->
      <view class="border-t border-gray-100 pt-3">
        <text class="block text-xs text-gray-400 mb-2">位置备注（帮助参与者找到你）</text>
        <t-input
          placeholder="如：4楼平台入口、星巴克门口"
          value="{{draft.locationHint}}"
          maxlength="{{50}}"
          bindinput="onLocationHintInput"
        />
      </view>
    </view>

    <!-- 人数信息 -->
    <view class="form-card bg-white rounded-lg p-4 mb-3">
      <view class="flex items-center gap-2">
        <t-icon name="user" size="36rpx" color="#FF6B35" />
        <text class="text-sm font-medium text-gray-900">参与人数</text>
        <text class="text-base text-gray-600 ml-auto">{{draft.maxParticipants}}人</text>
      </view>
    </view>

    <!-- 发布按钮 -->
    <view class="mt-6">
      <t-button
        theme="primary"
        size="large"
        block
        loading="{{submitting}}"
        disabled="{{submitting || isExpired}}"
        bindtap="onConfirmPublish"
      >
        {{isExpired ? '时间已过期，请修改' : '确认发布'}}
      </t-button>
      <view class="text-center text-xs text-gray-400 mt-3">
        发布后将消耗 1 次 AI 创建额度
      </view>
    </view>
  </view>

  <!-- 时间选择器 -->
  <t-date-time-picker
    visible="{{showTimePicker}}"
    mode="minute"
    value="{{draft.startAt}}"
    title="选择活动时间"
    cancelBtn="取消"
    confirmBtn="确定"
    start="{{Date.now()}}"
    bind:change="onTimeChange"
    bind:cancel="onTimePickerCancel"
  />
</view>
