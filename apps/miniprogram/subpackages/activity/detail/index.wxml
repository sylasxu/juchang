<!--
  æ´»åŠ¨è¯¦æƒ…é¡µ
  Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6
-->
<wxs module="utils">
  // æ ¼å¼åŒ–æ—¶é—´
  function formatTime(dateStr) {
    if (!dateStr) return '';
    var date = getDate(dateStr);
    var now = getDate();
    
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var timeStr = (hours < 10 ? '0' + hours : hours) + ':' + (minutes < 10 ? '0' + minutes : minutes);
    
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    var weekDay = weekDays[date.getDay()];
    
    return month + 'æœˆ' + day + 'æ—¥ ' + weekDay + ' ' + timeStr;
  }
  
  // è·å–è´¹ç”¨ç±»å‹æ–‡æœ¬
  function getFeeTypeText(feeType) {
    var map = {
      free: 'å…è´¹',
      aa: 'AAåˆ¶',
      fixed: 'å›ºå®šè´¹ç”¨',
      treat: 'è¯·å®¢'
    };
    return map[feeType] || feeType || '';
  }
  
  // è·å–æ´»åŠ¨ç±»å‹æ–‡æœ¬
  function getActivityTypeText(type) {
    var map = {
      food: 'ç¾é£Ÿ',
      entertainment: 'å¨±ä¹',
      sports: 'è¿åŠ¨',
      study: 'å­¦ä¹ ',
      travel: 'æ—…è¡Œ',
      other: 'å…¶ä»–'
    };
    return map[type] || type || '';
  }
  
  // è®¡ç®—é è°±åº¦
  function calculateReliability(user) {
    if (!user || !user.participationCount || user.participationCount === 0) {
      return -1;
    }
    return Math.round((user.fulfillmentCount / user.participationCount) * 100);
  }
  
  // è·å–é è°±åº¦æ ‡ç­¾
  function getReliabilityLabel(rate) {
    if (rate === -1) return 'ğŸ†• æ–°ç”¨æˆ·';
    if (rate === 100) return 'â­â­â­ éå¸¸é è°±';
    if (rate >= 80) return 'â­â­ é è°±';
    if (rate >= 60) return 'â­ ä¸€èˆ¬';
    return 'å¾…æå‡';
  }
  
  // è·å–å‚ä¸çŠ¶æ€æ–‡æœ¬
  function getStatusText(status) {
    var map = {
      pending: 'å®¡æ ¸ä¸­',
      approved: 'å·²é€šè¿‡',
      rejected: 'å·²æ‹’ç»'
    };
    return map[status] || '';
  }
  
  // è·å–åœ°å€æ˜¾ç¤º
  function getDisplayAddress(activity, participantStatus, isCreator) {
    if (!activity) return '';
    if (isCreator || participantStatus === 'approved') {
      return activity.address || activity.locationName || '';
    }
    if (activity.isLocationBlurred) {
      return activity.locationHint || 'ä½ç½®å¾…å®š';
    }
    return activity.address || activity.locationName || '';
  }
  
  module.exports = {
    formatTime: formatTime,
    getFeeTypeText: getFeeTypeText,
    getActivityTypeText: getActivityTypeText,
    calculateReliability: calculateReliability,
    getReliabilityLabel: getReliabilityLabel,
    getStatusText: getStatusText,
    getDisplayAddress: getDisplayAddress
  };
</wxs>

<view class="activity-detail">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="circular" size="80rpx" />
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-container">
    <t-icon name="error-circle" size="120rpx" color="#ff4d4f" />
    <text class="error-text">{{errorMsg || 'åŠ è½½å¤±è´¥'}}</text>
    <t-button theme="primary" size="small" bindtap="onRefresh">é‡è¯•</t-button>
  </view>
  
  <!-- æ´»åŠ¨å†…å®¹ -->
  <view wx:else class="content">
    <!-- æ´»åŠ¨å›¾ç‰‡è½®æ’­ -->
    <view class="image-section">
      <swiper wx:if="{{activity.images && activity.images.length > 0}}" 
              class="image-swiper" 
              indicator-dots="{{activity.images.length > 1}}"
              autoplay="{{false}}">
        <swiper-item wx:for="{{activity.images}}" wx:key="index">
          <image src="{{item}}" mode="aspectFill" class="activity-image" />
        </swiper-item>
      </swiper>
      <view wx:else class="image-placeholder">
        <t-icon name="image" size="80rpx" color="#ccc" />
        <text class="placeholder-text">æš‚æ— å›¾ç‰‡</text>
      </view>
      
      <!-- å¢å€¼æœåŠ¡æ ‡ç­¾ -->
      <view class="service-tags">
        <view wx:if="{{activity.isPinPlus}}" class="service-tag pinplus">
          <t-icon name="star-filled" size="24rpx" />
          <text>Pin+</text>
        </view>
        <view wx:if="{{activity.isBoosted}}" class="service-tag boost">
          <text>ğŸ”¥æ€¥æ‹›</text>
        </view>
      </view>
    </view>
    
    <!-- æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <!-- æ ‡é¢˜å’Œç±»å‹ -->
      <view class="title-row">
        <text class="activity-title">{{activity.title}}</text>
        <t-tag wx:if="{{activity.type}}" size="small" variant="light" theme="primary">
          {{utils.getActivityTypeText(activity.type)}}
        </t-tag>
      </view>
      
      <!-- æ´»åŠ¨çŠ¶æ€ -->
      <view wx:if="{{participantStatus}}" class="status-row">
        <t-tag size="small" variant="light" 
               theme="{{participantStatus === 'approved' ? 'success' : participantStatus === 'rejected' ? 'danger' : 'warning'}}">
          {{utils.getStatusText(participantStatus)}}
        </t-tag>
        <text wx:if="{{isCreator}}" class="creator-badge">æˆ‘å‘èµ·çš„</text>
      </view>
      
      <!-- æ—¶é—´ -->
      <view class="info-row">
        <t-icon name="time" size="36rpx" color="#FF6B35" />
        <view class="info-content">
          <text class="info-label">æ´»åŠ¨æ—¶é—´</text>
          <text class="info-value">{{utils.formatTime(activity.startAt)}}</text>
          <text wx:if="{{activity.endAt}}" class="info-value-sub">è‡³ {{utils.formatTime(activity.endAt)}}</text>
        </view>
      </view>
      
      <!-- åœ°ç‚¹ Requirements: 6.2 -->
      <view class="info-row">
        <t-icon name="location" size="36rpx" color="#FF6B35" />
        <view class="info-content">
          <text class="info-label">æ´»åŠ¨åœ°ç‚¹</text>
          <text class="info-value">{{utils.getDisplayAddress(activity, participantStatus, isCreator)}}</text>
          <text wx:if="{{activity.isLocationBlurred && !isCreator && participantStatus !== 'approved'}}" 
                class="info-hint">æŠ¥åé€šè¿‡åå¯æŸ¥çœ‹è¯¦ç»†åœ°å€</text>
          <text wx:if="{{activity.locationHint && (isCreator || participantStatus === 'approved')}}" 
                class="info-hint">{{activity.locationHint}}</text>
        </view>
      </view>
      
      <!-- äººæ•° -->
      <view class="info-row">
        <t-icon name="user" size="36rpx" color="#FF6B35" />
        <view class="info-content">
          <text class="info-label">å‚ä¸äººæ•°</text>
          <text class="info-value">{{activity.currentParticipants || 0}}/{{activity.maxParticipants}}äºº</text>
          <text wx:if="{{isHotActivity}}" class="hot-badge">ğŸ”¥çƒ­é—¨</text>
        </view>
      </view>
      
      <!-- è´¹ç”¨ -->
      <view class="info-row">
        <t-icon name="money-circle" size="36rpx" color="#FF6B35" />
        <view class="info-content">
          <text class="info-label">è´¹ç”¨</text>
          <text class="info-value">{{utils.getFeeTypeText(activity.feeType)}}</text>
          <text wx:if="{{activity.estimatedCost}}" class="info-value-sub">çº¦Â¥{{activity.estimatedCost}}</text>
        </view>
      </view>
      
      <!-- é è°±åº¦é—¨æ§› -->
      <view wx:if="{{activity.minReliabilityRate}}" class="info-row">
        <t-icon name="secured" size="36rpx" color="#FF6B35" />
        <view class="info-content">
          <text class="info-label">é è°±åº¦è¦æ±‚</text>
          <text class="info-value">â‰¥{{activity.minReliabilityRate}}%</text>
        </view>
      </view>
    </view>
    
    <!-- æ´»åŠ¨æè¿° -->
    <view wx:if="{{activity.description}}" class="description-section">
      <text class="section-title">æ´»åŠ¨è¯¦æƒ…</text>
      <text class="description-text">{{activity.description}}</text>
    </view>

    
    <!-- å‘èµ·äººä¿¡æ¯ Requirements: 6.3 -->
    <view class="creator-section" bindtap="onCreatorTap">
      <text class="section-title">å‘èµ·äºº</text>
      <view class="creator-card">
        <t-avatar 
          image="{{activity.creator.avatarUrl}}" 
          size="96rpx"
          icon="user"
        />
        <view class="creator-info">
          <text class="creator-name">{{activity.creator.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
          <view class="creator-stats">
            <text class="stat-item">ç»„ç»‡ {{activity.creator.organizationCount || 0}} åœº</text>
            <text class="stat-divider">|</text>
            <text class="stat-item">å‚ä¸ {{activity.creator.participationCount || 0}} åœº</text>
          </view>
        </view>
        <view class="creator-reliability">
          <text class="reliability-label">{{utils.getReliabilityLabel(utils.calculateReliability(activity.creator))}}</text>
          <text wx:if="{{utils.calculateReliability(activity.creator) >= 0}}" class="reliability-rate">
            {{utils.calculateReliability(activity.creator)}}%
          </text>
        </view>
        <t-icon name="chevron-right" size="32rpx" color="#ccc" />
      </view>
    </view>
    
    <!-- å‚ä¸è€…åˆ—è¡¨ï¼ˆä»…åˆ›å»ºè€…å’Œå·²é€šè¿‡å®¡æ ¸çš„ç”¨æˆ·å¯è§ï¼‰ -->
    <view wx:if="{{(isCreator || participantStatus === 'approved') && activity.participants && activity.participants.length > 0}}" 
          class="participants-section">
      <text class="section-title">å‚ä¸è€… ({{activity.participants.length}})</text>
      <view class="participants-list">
        <view wx:for="{{activity.participants}}" wx:key="id" class="participant-item">
          <t-avatar 
            image="{{item.user.avatarUrl}}" 
            size="64rpx"
            icon="user"
          />
          <view class="participant-info">
            <text class="participant-name">{{item.user.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
            <t-tag size="small" variant="light" 
                   theme="{{item.status === 'approved' ? 'success' : item.status === 'rejected' ? 'danger' : 'warning'}}">
              {{utils.getStatusText(item.status)}}
            </t-tag>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-bar">
      <!-- åˆ†äº«æŒ‰é’® -->
      <button class="share-btn" open-type="share">
        <t-icon name="share" size="40rpx" />
        <text>åˆ†äº«</text>
      </button>
      
      <!-- ç¾¤èŠæŒ‰é’®ï¼ˆä»…å·²é€šè¿‡å®¡æ ¸çš„å‚ä¸è€…å’Œåˆ›å»ºè€…å¯è§ï¼‰ -->
      <button wx:if="{{isCreator || participantStatus === 'approved'}}" 
              class="chat-btn" 
              bindtap="onEnterChat">
        <t-icon name="chat" size="40rpx" />
        <text>ç¾¤èŠ</text>
      </button>
      
      <!-- æŠ¥åæŒ‰é’® -->
      <button wx:if="{{!isCreator && !participantStatus}}" 
              class="join-btn" 
              bindtap="onJoinTap">
        æˆ‘è¦æŠ¥å
      </button>
      
      <!-- å·²æŠ¥åçŠ¶æ€ -->
      <view wx:elif="{{participantStatus && !isCreator}}" class="status-btn">
        <text>{{utils.getStatusText(participantStatus)}}</text>
      </view>
      
      <!-- åˆ›å»ºè€…æ“ä½œ -->
      <view wx:elif="{{isCreator}}" class="creator-actions">
        <button class="manage-btn" bindtap="onManageActivity">ç®¡ç†æ´»åŠ¨</button>
      </view>
    </view>
  </view>
  
  <!-- æŠ¥åå¯¹è¯æ¡† -->
  <t-popup visible="{{showJoinDialog}}" placement="bottom" bind:visible-change="onCloseJoinDialog">
    <view class="join-dialog">
      <view class="dialog-header">
        <text class="dialog-title">æŠ¥åå‚åŠ </text>
        <t-icon name="close" size="40rpx" bindtap="onCloseJoinDialog" />
      </view>
      
      <view class="dialog-content">
        <!-- ç•™è¨€è¾“å…¥ -->
        <view class="input-group">
          <text class="input-label">ç•™è¨€ï¼ˆé€‰å¡«ï¼‰</text>
          <textarea class="message-input" 
                    placeholder="å‘å‘èµ·äººä»‹ç»ä¸€ä¸‹è‡ªå·±å§~" 
                    value="{{joinMessage}}"
                    bindinput="onJoinMessageInput"
                    maxlength="200" />
        </view>
        
        <!-- Fast Passé€‰é¡¹ Requirements: 6.6 -->
        <view wx:if="{{isHotActivity}}" class="fastpass-group">
          <view class="fastpass-header">
            <t-checkbox value="{{useFastPass}}" bind:change="onFastPassChange" />
            <text class="fastpass-title">ä¼˜å…ˆå…¥åœºåˆ¸ (Fast Pass)</text>
            <text class="fastpass-price">Â¥{{fastPassPrice}}</text>
          </view>
          <text class="fastpass-desc">çƒ­é—¨æ´»åŠ¨ï¼Œä½¿ç”¨Fast Passå¯è®©ä½ çš„ç”³è¯·åœ¨å®¡æ‰¹åˆ—è¡¨ä¸­ç½®é¡¶æ˜¾ç¤º</text>
        </view>
      </view>
      
      <view class="dialog-footer">
        <t-button theme="light" size="large" bindtap="onCloseJoinDialog">å–æ¶ˆ</t-button>
        <t-button theme="primary" size="large" loading="{{isJoining}}" bindtap="onConfirmJoin">
          {{useFastPass ? 'æ”¯ä»˜Â¥' + fastPassPrice + 'å¹¶æŠ¥å' : 'ç¡®è®¤æŠ¥å'}}
        </t-button>
      </view>
    </view>
  </t-popup>
</view>
