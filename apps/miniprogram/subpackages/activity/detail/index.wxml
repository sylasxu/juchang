<!--
  æ´»åŠ¨è¯¦æƒ…é¡µ
  TDesign + Atomic Less é‡æ„
-->
<wxs module="utils">
  function formatTime(dateStr) {
    if (!dateStr) return '';
    var date = getDate(dateStr);
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var timeStr = (hours < 10 ? '0' + hours : hours) + ':' + (minutes < 10 ? '0' + minutes : minutes);
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    var weekDay = weekDays[date.getDay()];
    return month + 'æœˆ' + day + 'æ—¥ ' + weekDay + ' ' + timeStr;
  }
  
  function getFeeTypeText(feeType) {
    var map = { free: 'å…è´¹', aa: 'AAåˆ¶', fixed: 'å›ºå®šè´¹ç”¨', treat: 'è¯·å®¢' };
    return map[feeType] || feeType || '';
  }
  
  function getActivityTypeText(type) {
    var map = { food: 'ç¾é£Ÿ', entertainment: 'å¨±ä¹', sports: 'è¿åŠ¨', study: 'å­¦ä¹ ', travel: 'æ—…è¡Œ', other: 'å…¶ä»–' };
    return map[type] || type || '';
  }
  
  function calculateReliability(user) {
    if (!user || !user.participationCount || user.participationCount === 0) return -1;
    return Math.round((user.fulfillmentCount / user.participationCount) * 100);
  }
  
  function getStatusText(status) {
    var map = { pending: 'å®¡æ ¸ä¸­', approved: 'å·²é€šè¿‡', rejected: 'å·²æ‹’ç»' };
    return map[status] || '';
  }
  
  function getDisplayAddress(activity, participantStatus, isCreator) {
    if (!activity) return '';
    if (isCreator || participantStatus === 'approved') return activity.address || activity.locationName || '';
    if (activity.isLocationBlurred) return activity.locationHint || 'ä½ç½®å¾…å®š';
    return activity.address || activity.locationName || '';
  }
  
  module.exports = {
    formatTime: formatTime,
    getFeeTypeText: getFeeTypeText,
    getActivityTypeText: getActivityTypeText,
    calculateReliability: calculateReliability,
    getStatusText: getStatusText,
    getDisplayAddress: getDisplayAddress
  };
</wxs>

<view class="min-h-screen bg-gray-50 pb-bottom-bar">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <custom-navbar 
    title="æ´»åŠ¨è¯¦æƒ…" 
    showMenu="{{false}}" 
    showMore="{{false}}"
    showBack="{{true}}"
    transparent="{{!loading && !error}}"
  />

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="flex flex-col items-center justify-center min-h-screen py-5">
    <t-loading theme="circular" size="80rpx" />
    <text class="mt-3 text-sm text-gray-400">åŠ è½½ä¸­...</text>
  </view>
  
  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="flex flex-col items-center justify-center min-h-screen py-5">
    <t-icon name="error-circle" size="120rpx" color="#FF4D4F" />
    <text class="mt-3 mb-4 text-sm text-gray-400">{{errorMsg || 'åŠ è½½å¤±è´¥'}}</text>
    <t-button theme="primary" size="small" bindtap="onRefresh">é‡è¯•</t-button>
  </view>
  
  <!-- æ´»åŠ¨å†…å®¹ -->
  <view wx:else>
    <!-- æ´»åŠ¨å›¾ç‰‡è½®æ’­ -->
    <view class="relative w-full h-480 bg-gray-100">
      <swiper wx:if="{{activity.images && activity.images.length > 0}}" 
              class="w-full h-full" 
              indicator-dots="{{activity.images.length > 1}}"
              autoplay="{{false}}">
        <swiper-item wx:for="{{activity.images}}" wx:key="index">
          <image src="{{item}}" mode="aspectFill" class="w-full h-full" />
        </swiper-item>
      </swiper>
      <view wx:else class="flex flex-col items-center justify-center w-full h-full bg-gray-100">
        <t-icon name="image" size="80rpx" color="#D1D5DB" />
        <text class="mt-2 text-sm text-gray-300">æš‚æ— å›¾ç‰‡</text>
      </view>
      
      <!-- å¢å€¼æœåŠ¡æ ‡ç­¾ -->
      <view class="absolute top-3 left-3 flex gap-2">
        <view wx:if="{{activity.isPinPlus}}" class="service-tag pinplus flex items-center gap-1 px-2 py-1 rounded-sm text-xs text-white">
          <t-icon name="star-filled" size="24rpx" />
          <text>Pin+</text>
        </view>
        <view wx:if="{{activity.isBoosted}}" class="service-tag boost px-2 py-1 rounded-sm text-xs text-white">
          <text>ğŸ”¥æ€¥æ‹›</text>
        </view>
      </view>
    </view>
    
    <!-- æ´»åŠ¨åŸºæœ¬ä¿¡æ¯ -->
    <view class="bg-white p-4 mb-2">
      <!-- æ ‡é¢˜å’Œç±»å‹ -->
      <view class="flex items-start justify-between mb-3">
        <text class="flex-1 text-xl font-semibold text-gray-900 leading-relaxed mr-2">{{activity.title}}</text>
        <t-tag wx:if="{{activity.type}}" size="small" variant="light" theme="primary">
          {{utils.getActivityTypeText(activity.type)}}
        </t-tag>
      </view>
      
      <!-- æ´»åŠ¨çŠ¶æ€ -->
      <view wx:if="{{participantStatus}}" class="flex items-center gap-2 mb-3">
        <t-tag size="small" variant="light" 
               theme="{{participantStatus === 'approved' ? 'success' : participantStatus === 'rejected' ? 'danger' : 'warning'}}">
          {{utils.getStatusText(participantStatus)}}
        </t-tag>
        <text wx:if="{{isCreator}}" class="text-xs text-brand bg-brand-light px-2 py-1 rounded-sm">æˆ‘å‘èµ·çš„</text>
      </view>
      
      <!-- æ—¶é—´ -->
      <view class="info-row flex items-start py-3">
        <t-icon name="time" size="36rpx" color="#FF6B35" />
        <view class="flex-1 ml-3">
          <text class="block text-xs text-gray-400 mb-1">æ´»åŠ¨æ—¶é—´</text>
          <text class="block text-base font-medium text-gray-900">{{utils.formatTime(activity.startAt)}}</text>
          <text wx:if="{{activity.endAt}}" class="block text-sm text-gray-600 mt-1">è‡³ {{utils.formatTime(activity.endAt)}}</text>
        </view>
      </view>
      
      <!-- åœ°ç‚¹ -->
      <view class="info-row flex items-start py-3">
        <t-icon name="location" size="36rpx" color="#FF6B35" />
        <view class="flex-1 ml-3">
          <text class="block text-xs text-gray-400 mb-1">æ´»åŠ¨åœ°ç‚¹</text>
          <text class="block text-base font-medium text-gray-900">{{utils.getDisplayAddress(activity, participantStatus, isCreator)}}</text>
          <text wx:if="{{activity.isLocationBlurred && !isCreator && participantStatus !== 'approved'}}" 
                class="block text-xs text-brand mt-1">æŠ¥åé€šè¿‡åå¯æŸ¥çœ‹è¯¦ç»†åœ°å€</text>
          <text wx:if="{{activity.locationHint && (isCreator || participantStatus === 'approved')}}" 
                class="block text-xs text-brand mt-1">{{activity.locationHint}}</text>
        </view>
      </view>
      
      <!-- äººæ•° -->
      <view class="info-row flex items-start py-3">
        <t-icon name="user" size="36rpx" color="#FF6B35" />
        <view class="flex-1 ml-3">
          <text class="block text-xs text-gray-400 mb-1">å‚ä¸äººæ•°</text>
          <text class="block text-base font-medium text-gray-900">
            {{activity.currentParticipants || 0}}/{{activity.maxParticipants}}äºº
            <text wx:if="{{isHotActivity}}" class="text-xs text-error ml-2">ğŸ”¥çƒ­é—¨</text>
          </text>
        </view>
      </view>
      
      <!-- è´¹ç”¨ -->
      <view class="info-row flex items-start py-3">
        <t-icon name="money-circle" size="36rpx" color="#FF6B35" />
        <view class="flex-1 ml-3">
          <text class="block text-xs text-gray-400 mb-1">è´¹ç”¨</text>
          <text class="block text-base font-medium text-gray-900">{{utils.getFeeTypeText(activity.feeType)}}</text>
          <text wx:if="{{activity.estimatedCost}}" class="block text-sm text-gray-600 mt-1">çº¦Â¥{{activity.estimatedCost}}</text>
        </view>
      </view>
      
      <!-- é è°±åº¦é—¨æ§› -->
      <view wx:if="{{activity.minReliabilityRate}}" class="info-row flex items-start py-3">
        <t-icon name="secured" size="36rpx" color="#FF6B35" />
        <view class="flex-1 ml-3">
          <text class="block text-xs text-gray-400 mb-1">é è°±åº¦è¦æ±‚</text>
          <text class="block text-base font-medium text-gray-900">â‰¥{{activity.minReliabilityRate}}%</text>
        </view>
      </view>
    </view>
    
    <!-- æ´»åŠ¨æè¿° -->
    <view wx:if="{{activity.description}}" class="bg-white p-4 mb-2">
      <text class="block text-lg font-semibold text-gray-900 mb-3">æ´»åŠ¨è¯¦æƒ…</text>
      <text class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">{{activity.description}}</text>
    </view>
    
    <!-- å‘èµ·äººä¿¡æ¯ -->
    <view class="bg-white p-4 mb-2" bindtap="onCreatorTap">
      <text class="block text-lg font-semibold text-gray-900 mb-3">å‘èµ·äºº</text>
      <view class="creator-card flex items-center p-3 rounded-md">
        <t-avatar image="{{activity.creator.avatarUrl}}" size="96rpx" icon="user" />
        <view class="flex-1 ml-3 min-w-0">
          <text class="block text-base font-medium text-gray-900 mb-1">{{activity.creator.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
          <view class="flex items-center text-xs text-gray-400">
            <text>ç»„ç»‡ {{activity.creator.organizationCount || 0}} åœº</text>
            <text class="mx-2 text-gray-200">|</text>
            <text>å‚ä¸ {{activity.creator.participationCount || 0}} åœº</text>
          </view>
        </view>
        <reliability-badge rate="{{utils.calculateReliability(activity.creator)}}" show-label="{{true}}" />
        <t-icon name="chevron-right" size="32rpx" color="#D1D5DB" />
      </view>
    </view>
    
    <!-- å‚ä¸è€…åˆ—è¡¨ -->
    <view wx:if="{{(isCreator || participantStatus === 'approved') && activity.participants && activity.participants.length > 0}}" 
          class="bg-white p-4 mb-2">
      <text class="block text-lg font-semibold text-gray-900 mb-3">å‚ä¸è€… ({{activity.participants.length}})</text>
      <view class="flex flex-wrap gap-3">
        <view wx:for="{{activity.participants}}" wx:key="id" class="participant-item flex items-center p-2 rounded-sm">
          <t-avatar image="{{item.user.avatarUrl}}" size="64rpx" icon="user" />
          <view class="flex-1 ml-2 min-w-0">
            <text class="block text-sm text-gray-900 truncate mb-1">{{item.user.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
            <t-tag size="small" variant="light" 
                   theme="{{item.status === 'approved' ? 'success' : item.status === 'rejected' ? 'danger' : 'warning'}}">
              {{utils.getStatusText(item.status)}}
            </t-tag>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-bar flex items-center px-4 py-3">
      <button class="share-btn flex flex-col items-center justify-center w-100 h-100 text-xs text-gray-600" open-type="share">
        <t-icon name="share" size="40rpx" />
        <text>åˆ†äº«</text>
      </button>
      
      <button wx:if="{{isCreator || participantStatus === 'approved'}}" 
              class="chat-btn flex flex-col items-center justify-center w-100 h-100 text-xs text-gray-600 ml-2" 
              bindtap="onEnterChat">
        <t-icon name="chat" size="40rpx" />
        <text>ç¾¤èŠ</text>
      </button>
      
      <button wx:if="{{!isCreator && !participantStatus}}" 
              class="join-btn flex-1 h-88 ml-4 text-white text-lg font-medium rounded-full" 
              bindtap="onJoinTap">
        æˆ‘è¦æŠ¥å
      </button>
      
      <view wx:elif="{{participantStatus && !isCreator}}" 
            class="flex-1 flex items-center justify-center h-88 ml-4 bg-gray-100 text-gray-400 text-lg rounded-full">
        <text>{{utils.getStatusText(participantStatus)}}</text>
      </view>
      
      <view wx:elif="{{isCreator}}" class="flex-1 ml-4">
        <button class="manage-btn w-full h-88 text-white text-lg font-medium rounded-full" bindtap="onManageActivity">ç®¡ç†æ´»åŠ¨</button>
      </view>
    </view>
  </view>
  
  <!-- æŠ¥åå¯¹è¯æ¡† -->
  <t-popup visible="{{showJoinDialog}}" placement="bottom" bind:visible-change="onCloseJoinDialog">
    <view class="join-dialog bg-white">
      <view class="flex items-center justify-between p-4 border-b border-gray-100">
        <text class="text-xl font-semibold text-gray-900">æŠ¥åå‚åŠ </text>
        <t-icon name="close" size="40rpx" bindtap="onCloseJoinDialog" />
      </view>
      
      <view class="p-4">
        <view class="mb-4">
          <text class="block text-sm text-gray-900 mb-2">ç•™è¨€ï¼ˆé€‰å¡«ï¼‰</text>
          <textarea class="message-input" 
                    placeholder="å‘å‘èµ·äººä»‹ç»ä¸€ä¸‹è‡ªå·±å§~" 
                    value="{{joinMessage}}"
                    bindinput="onJoinMessageInput"
                    maxlength="200" />
        </view>
        
        <view wx:if="{{isHotActivity}}" class="fastpass-group p-3 rounded-md">
          <view class="flex items-center mb-2">
            <t-checkbox value="{{useFastPass}}" bind:change="onFastPassChange" />
            <text class="flex-1 text-sm font-medium text-gray-900 ml-2">ä¼˜å…ˆå…¥åœºåˆ¸ (Fast Pass)</text>
            <text class="text-lg font-semibold text-brand">Â¥{{fastPassPrice}}</text>
          </view>
          <text class="block text-xs text-gray-400 leading-normal ml-6">çƒ­é—¨æ´»åŠ¨ï¼Œä½¿ç”¨Fast Passå¯è®©ä½ çš„ç”³è¯·åœ¨å®¡æ‰¹åˆ—è¡¨ä¸­ç½®é¡¶æ˜¾ç¤º</text>
        </view>
      </view>
      
      <view class="flex gap-3 p-4 border-t border-gray-100">
        <t-button theme="light" size="large" class="flex-1" bindtap="onCloseJoinDialog">å–æ¶ˆ</t-button>
        <t-button theme="primary" size="large" class="flex-1" loading="{{isJoining}}" bindtap="onConfirmJoin">
          {{useFastPass ? 'æ”¯ä»˜Â¥' + fastPassPrice + 'å¹¶æŠ¥å' : 'ç¡®è®¤æŠ¥å'}}
        </t-button>
      </view>
    </view>
  </t-popup>
  
  <!-- æ´»åŠ¨ç®¡ç†æ“ä½œé¢æ¿ -->
  <t-action-sheet
    visible="{{showManageSheet}}"
    items="{{manageActions}}"
    bind:selected="onManageActionSelect"
    bind:cancel="onManageSheetClose"
    bind:close="onManageSheetClose"
  />
  
  <!-- æ‰‹æœºå·ç»‘å®šåŠå± -->
  <auth-sheet 
    visible="{{isAuthSheetVisible}}" 
    bind:success="onAuthSuccess"
    bind:close="onAuthClose"
  />
</view>
