// Notification Service - MVP 简化版 + Admin 扩展
import { db, notifications, users, eq, count, and, desc } from '@juchang/db';
import type { NotificationListQuery, NotificationListResponse, UnreadCountResponse } from './notification.model';

// 通知类型枚举值
const NOTIFICATION_TYPES = ['join', 'quit', 'activity_start', 'completed', 'cancelled'] as const;
type NotificationType = typeof NOTIFICATION_TYPES[number];

/** 类型守卫：检查是否为有效的通知类型 */
function isNotificationType(value: string): value is NotificationType {
  return NOTIFICATION_TYPES.includes(value as NotificationType);
}

/**
 * 获取用户通知列表（用户模式）
 */
export async function getNotifications(
  userId: string,
  query: NotificationListQuery
): Promise<NotificationListResponse> {
  const { page = 1, limit = 20, type } = query;
  const offset = (page - 1) * limit;

  // 构建查询条件
  const conditions = [eq(notifications.userId, userId)];
  if (type && isNotificationType(type)) {
    conditions.push(eq(notifications.type, type));
  }

  const [data, totalResult] = await Promise.all([
    db
      .select()
      .from(notifications)
      .where(and(...conditions))
      .limit(limit)
      .offset(offset)
      .orderBy(desc(notifications.createdAt)),
    db
      .select({ count: count() })
      .from(notifications)
      .where(and(...conditions)),
  ]);

  const total = totalResult[0]?.count || 0;
  const totalPages = Math.ceil(total / limit);

  return { data, total, page, totalPages };
}

/**
 * 获取所有用户的通知列表（Admin 模式）
 */
export async function getAllNotifications(
  query: NotificationListQuery
): Promise<NotificationListResponse & { data: Array<any> }> {
  const { page = 1, limit = 20, type } = query;
  const offset = (page - 1) * limit;

  // 构建查询条件
  const conditions = [];
  if (type && isNotificationType(type)) {
    conditions.push(eq(notifications.type, type));
  }

  const whereCondition = conditions.length > 0 ? and(...conditions) : undefined;

  // 查询通知列表（包含用户信息）
  const [data, totalResult] = await Promise.all([
    db
      .select({
        id: notifications.id,
        userId: notifications.userId,
        type: notifications.type,
        title: notifications.title,
        content: notifications.content,
        isRead: notifications.isRead,
        activityId: notifications.activityId,
        createdAt: notifications.createdAt,
        userNickname: users.nickname,
        userAvatarUrl: users.avatarUrl,
      })
      .from(notifications)
      .leftJoin(users, eq(notifications.userId, users.id))
      .where(whereCondition)
      .limit(limit)
      .offset(offset)
      .orderBy(desc(notifications.createdAt)),
    db
      .select({ count: count() })
      .from(notifications)
      .where(whereCondition),
  ]);

  const total = totalResult[0]?.count || 0;
  const totalPages = Math.ceil(total / limit);

  return { data, total, page, totalPages };
}

/**
 * 获取指定用户的通知列表（Admin 查指定用户）
 */
export async function getNotificationsByUserId(
  targetUserId: string,
  query: NotificationListQuery
): Promise<NotificationListResponse & { data: Array<any> }> {
  const { page = 1, limit = 20, type } = query;
  const offset = (page - 1) * limit;

  // 构建查询条件
  const conditions = [eq(notifications.userId, targetUserId)];
  if (type && isNotificationType(type)) {
    conditions.push(eq(notifications.type, type));
  }

  // 查询通知列表（包含用户信息）
  const [data, totalResult] = await Promise.all([
    db
      .select({
        id: notifications.id,
        userId: notifications.userId,
        type: notifications.type,
        title: notifications.title,
        content: notifications.content,
        isRead: notifications.isRead,
        activityId: notifications.activityId,
        createdAt: notifications.createdAt,
        userNickname: users.nickname,
        userAvatarUrl: users.avatarUrl,
      })
      .from(notifications)
      .leftJoin(users, eq(notifications.userId, users.id))
      .where(and(...conditions))
      .limit(limit)
      .offset(offset)
      .orderBy(desc(notifications.createdAt)),
    db
      .select({ count: count() })
      .from(notifications)
      .where(and(...conditions)),
  ]);

  const total = totalResult[0]?.count || 0;
  const totalPages = Math.ceil(total / limit);

  return { data, total, page, totalPages };
}

/**
 * 标记通知为已读
 */
export async function markAsRead(id: string, userId: string): Promise<boolean> {
  const [updated] = await db
    .update(notifications)
    .set({
      isRead: true,
    })
    .where(and(eq(notifications.id, id), eq(notifications.userId, userId)))
    .returning();

  return !!updated;
}

/**
 * 获取未读通知数量
 */
export async function getUnreadCount(userId: string): Promise<UnreadCountResponse> {
  const [result] = await db
    .select({ count: count() })
    .from(notifications)
    .where(and(eq(notifications.userId, userId), eq(notifications.isRead, false)));

  return { count: result?.count || 0 };
}

// ==========================================
// 内部调用：创建通知
// DB 枚举类型: join, quit, activity_start, completed, cancelled
// ==========================================

interface CreateNotificationParams {
  userId: string;
  type: NotificationType;
  title: string;
  content?: string;
  activityId?: string;
}

/**
 * 创建通知（内部调用）
 */
export async function createNotification(params: CreateNotificationParams) {
  const { userId, type, title, content, activityId } = params;

  const [notification] = await db
    .insert(notifications)
    .values({
      userId,
      type,
      title,
      content: content || null,
      activityId: activityId || null,
      isRead: false,
    })
    .returning();

  return notification;
}

/**
 * 创建加入通知 - 有人报名活动
 */
export async function notifyJoin(
  organizerId: string,
  activityId: string,
  activityTitle: string,
  applicantName: string
) {
  return createNotification({
    userId: organizerId,
    type: 'join',
    title: '新成员加入',
    content: `${applicantName} 加入了「${activityTitle}」`,
    activityId,
  });
}

/**
 * 创建退出通知 - 有人退出活动
 */
export async function notifyQuit(
  organizerId: string,
  activityId: string,
  activityTitle: string,
  memberName: string
) {
  return createNotification({
    userId: organizerId,
    type: 'quit',
    title: '成员退出',
    content: `${memberName} 退出了「${activityTitle}」`,
    activityId,
  });
}

/**
 * 创建活动即将开始通知
 */
export async function notifyActivityStart(
  userId: string,
  activityId: string,
  activityTitle: string
) {
  return createNotification({
    userId,
    type: 'activity_start',
    title: '活动即将开始',
    content: `「${activityTitle}」即将开始`,
    activityId,
  });
}

/**
 * 创建活动成局通知
 */
export async function notifyCompleted(
  userId: string,
  activityId: string,
  activityTitle: string
) {
  return createNotification({
    userId,
    type: 'completed',
    title: '活动成局',
    content: `「${activityTitle}」已成局`,
    activityId,
  });
}

/**
 * 创建活动取消通知
 */
export async function notifyCancelled(
  userId: string,
  activityId: string,
  activityTitle: string
) {
  return createNotification({
    userId,
    type: 'cancelled',
    title: '活动取消',
    content: `「${activityTitle}」已取消`,
    activityId,
  });
}
