# èšåœº (Juchang) - API è·¯ç”±å¼€å‘å‡†åˆ™

## ğŸ“‹ æ ¸å¿ƒåŸåˆ™

### 1. **Single Source of Truth: æ•°æ®åº“ Schema ä¼˜å…ˆ**
- **ç¦æ­¢æ‰‹åŠ¨å®šä¹‰ Zod Schema**ï¼šæ‰€æœ‰ API å“åº”/è¯·æ±‚çš„ Schema å¿…é¡»ä» `@juchang/db` å¯¼å‡ºçš„ schema æ´¾ç”Ÿ
- **ä½¿ç”¨ `.pick()` å’Œ `.extend()`**ï¼šé€šè¿‡ `selectUserSchema.pick({ ... })` æˆ– `selectActivitySchema.extend({ ... })` æ„å»ºå“åº”ç»“æ„
- **ç¤ºä¾‹**ï¼š
  ```typescript
  // âœ… æ­£ç¡®ï¼šä» db schema æ´¾ç”Ÿ
  const activityDetailResponse = selectActivitySchema
    .omit({ creatorId: true })
    .extend({
      creator: selectUserSchema.pick({
        id: true,
        nickname: true,
        avatarUrl: true,
        creditScore: true,
      }),
    });
  
  // âŒ é”™è¯¯ï¼šæ‰‹åŠ¨å®šä¹‰
  const activityDetailResponse = z.object({
    id: z.string(),
    title: z.string(),
    creator: z.object({ ... }),
  });
  ```

### 2. **Route å’Œ Handler åˆ†ç¦»æ¨¡å¼**
- **Route å®šä¹‰**ï¼šä½¿ç”¨ `createRoute` å®šä¹‰ OpenAPI å¥‘çº¦ï¼ŒåŒ…å«è¯·æ±‚å‚æ•°ã€å“åº” schema
- **Handler å®ç°**ï¼šä½¿ç”¨ `RouteHandler<typeof route>` ç±»å‹æ ‡æ³¨ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘
- **æ–‡ä»¶ç»“æ„**ï¼š
  ```typescript
  // ==========================================
  // 1. è·¯ç”±å®šä¹‰ï¼ˆOpenAPI å¥‘çº¦ï¼‰
  // ==========================================
  export const getById = createRoute({
    method: 'get',
    path: '/activities/{id}',
    tags: [TAG],
    summary: 'è·å–æ´»åŠ¨è¯¦æƒ…',
    request: { ... },
    responses: { ... },
  });
  
  // ==========================================
  // 2. Handler å®ç°ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
  // ==========================================
  export const getByIdHandler: RouteHandler<typeof getById> = async (c) => {
    const { id } = c.req.valid('param');
    const result = await activityService.getById(id);
    return c.json(result);
  };
  ```

### 3. **ä»£ç ç»„ç»‡è§„èŒƒ**

#### 3.1 å¯¼å…¥é¡ºåº
```typescript
// 1. Hono/OpenAPI ç›¸å…³
import { createRoute, type RouteHandler } from '@hono/zod-openapi';
import { z } from 'zod';

// 2. DB Schemaï¼ˆä¼˜å…ˆä½¿ç”¨å¯¼å‡ºçš„ schemaï¼‰
import { selectActivitySchema, selectUserSchema } from '@juchang/db';

// 3. Services
import { activityService } from '@juchang/services';

// 4. å…¶ä»–å·¥å…·
import { paginationParams } from '../../pipes/pagination.pipe';
```

#### 3.2 Schema å®šä¹‰åŒºåŸŸ
```typescript
const TAG = 'Activities';

// --- è¾…åŠ© Schema (API å±‚ä¸“ç”¨ï¼Œç”¨äºåŒ…è£…å“åº”) ---
// ä½¿ç”¨æ³¨é‡Šè¯´æ˜ Schema çš„ç”¨é€”å’Œæ„å»ºæ–¹å¼
const activityDetailResponse = selectActivitySchema
  .omit({ creatorId: true })
  .extend({ ... });
```

#### 3.3 è·¯ç”±å®šä¹‰åŒºåŸŸ
```typescript
// ==========================================
// 1. è·¯ç”±åç§°ï¼ˆä½¿ç”¨æ•°å­—ç¼–å·ï¼Œä¾¿äºæ’åºï¼‰
// ==========================================
export const getById = createRoute({ ... });
```

### 4. **ç±»å‹å¤ç”¨æœ€ä½³å®è·µ**

#### 4.1 å…³è”æ•°æ® Schema
- **Creator/User ä¿¡æ¯**ï¼šä½¿ç”¨ `selectUserSchema.pick({ ... })` é€‰æ‹©éœ€è¦çš„å­—æ®µ
- **Participants åˆ—è¡¨**ï¼šä½¿ç”¨ `selectParticipantSchema.extend({ user: ... })` æ‰©å±•å…³è”æ•°æ®
- **é¿å…é‡å¤å®šä¹‰**ï¼šæ‰€æœ‰ç”¨æˆ·ç›¸å…³å­—æ®µéƒ½ä» `selectUserSchema` æ´¾ç”Ÿ

#### 4.2 ç‰¹æ®Šå­—æ®µå¤„ç†
- **Geometry ç±»å‹**ï¼šPostGIS çš„ `geometry` ç±»å‹éœ€è¦åœ¨ handler ä¸­è½¬æ¢ä¸º `[lng, lat]` æ•°ç»„
- **Omit å†…éƒ¨ ID**ï¼šå¦‚æœè¿”å›å®Œæ•´çš„å…³è”å¯¹è±¡ï¼Œä½¿ç”¨ `.omit({ foreignKeyId: true })` ç§»é™¤å¤–é”®å­—æ®µ

### 5. **é”™è¯¯å¤„ç†è§„èŒƒ**
```typescript
export const getByIdHandler: RouteHandler<typeof getById> = async (c) => {
  try {
    const result = await service.method();
    return c.json(result, 200);
  } catch (error) {
    if (error instanceof Error && error.message === 'èµ„æºä¸å­˜åœ¨') {
      return c.json({ code: 404, msg: 'èµ„æºä¸å­˜åœ¨' } as const, 404);
    }
    throw error;
  }
};
```

### 6. **å“åº” Schema å®šä¹‰**
- **æˆåŠŸå“åº”**ï¼šç›´æ¥ä½¿ç”¨ä» db schema æ´¾ç”Ÿçš„ç±»å‹
- **é”™è¯¯å“åº”**ï¼šç»Ÿä¸€ä½¿ç”¨ `{ code: number, msg: string }` æ ¼å¼
- **ç¤ºä¾‹**ï¼šåœ¨ `responses` ä¸­æ˜ç¡®å®šä¹‰æ‰€æœ‰å¯èƒ½çš„å“åº”çŠ¶æ€ç å’Œ schema

### 7. **æ³¨é‡Šè§„èŒƒ**
- ä½¿ç”¨ `// âœ…` æ ‡è®°ç¬¦åˆè§„èŒƒçš„ä»£ç 
- ä½¿ç”¨ `// âŒ` æ ‡è®°ç¦æ­¢çš„åšæ³•
- ä½¿ç”¨ `// --- åŒºåŸŸè¯´æ˜ ---` åˆ†éš”ä»£ç åŒºåŸŸ
- ä½¿ç”¨ `// ==========================================` åˆ†éš”è·¯ç”±å®šä¹‰

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹

å‚è€ƒ `apps/api/src/modules/activities/activities.route.ts` å’Œ `apps/api/src/modules/users/users.route.ts` ä½œä¸ºæ ‡å‡†å®ç°ã€‚

